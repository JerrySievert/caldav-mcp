<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 650 900" width="650" height="900">
  <defs>
    <style>
      .title { font: bold 20px sans-serif; fill: #333; }
      .node-text { font: bold 12px sans-serif; fill: #fff; text-anchor: middle; }
      .node-sub { font: 10px sans-serif; fill: rgba(255,255,255,0.85); text-anchor: middle; }
      .decision-text { font: bold 11px sans-serif; fill: #fff; text-anchor: middle; }
      .label-text { font: bold 11px sans-serif; fill: #444; }
      .yes-label { font: bold 11px sans-serif; fill: #2d6a4f; }
      .no-label { font: bold 11px sans-serif; fill: #c1292e; }
      .arrow { stroke: #444; stroke-width: 1.8; marker-end: url(#arrowhead); }
      .arrow-yes { stroke: #2d6a4f; stroke-width: 1.8; marker-end: url(#arrowhead-yes); }
      .arrow-no { stroke: #c1292e; stroke-width: 1.8; marker-end: url(#arrowhead-no); }
    </style>

    <!-- Arrowhead markers -->
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#444"/>
    </marker>
    <marker id="arrowhead-yes" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2d6a4f"/>
    </marker>
    <marker id="arrowhead-no" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#c1292e"/>
    </marker>

    <!-- Drop shadow -->
    <filter id="shadow" x="-4%" y="-4%" width="108%" height="108%">
      <feDropShadow dx="1" dy="1" stdDeviation="2" flood-opacity="0.15"/>
    </filter>

    <!-- Node gradients -->
    <linearGradient id="startGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#5a9fd4"/>
      <stop offset="100%" stop-color="#4a90d9"/>
    </linearGradient>
    <linearGradient id="processGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#6b9def"/>
      <stop offset="100%" stop-color="#5b8def"/>
    </linearGradient>
    <linearGradient id="decisionGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#f0a14a"/>
      <stop offset="100%" stop-color="#e8913a"/>
    </linearGradient>
    <linearGradient id="endGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#2ebd6a"/>
      <stop offset="100%" stop-color="#27ae60"/>
    </linearGradient>
    <linearGradient id="errorGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#f05c4c"/>
      <stop offset="100%" stop-color="#e74c3c"/>
    </linearGradient>
  </defs>

  <!-- Background -->
  <rect width="650" height="900" fill="#fafbfc" rx="8"/>

  <!-- Title -->
  <text x="325" y="35" class="title" text-anchor="middle">GET Event Flow</text>

  <!-- ============================================================ -->
  <!-- NODE 1: START -->
  <!-- Ellipse: cx=245, cy=70, rx=120, ry=26 -->
  <!-- ============================================================ -->
  <ellipse cx="245" cy="70" rx="120" ry="26" fill="url(#startGrad)" filter="url(#shadow)"/>
  <text x="245" y="68" class="node-text">GET Request</text>
  <text x="245" y="82" class="node-sub">/{username}/{calendar_id}/{uid}.ics</text>

  <!-- Arrow: START bottom (245,96) -> Decision1 top (245,107) -->
  <line x1="245" y1="96" x2="245" y2="107" class="arrow"/>

  <!-- ============================================================ -->
  <!-- NODE 2: DECISION - Is method OPTIONS? -->
  <!-- Diamond: cx=245, cy=147, dx=100, dy=40 -->
  <!-- Top: (245,107), Right: (345,147), Bottom: (245,187), Left: (145,147) -->
  <!-- ============================================================ -->
  <polygon points="245,107 345,147 245,187 145,147" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="245" y="145" class="decision-text">Is method</text>
  <text x="245" y="157" class="decision-text">OPTIONS?</text>

  <!-- Yes arrow: Right vertex (345,147) -> Return 200 DAV rect left (430,131) -->
  <line x1="345" y1="147" x2="427" y2="147" class="arrow-yes"/>
  <text x="370" y="140" class="yes-label">Yes</text>

  <!-- ============================================================ -->
  <!-- NODE 2a: Return 200 with DAV headers -> END -->
  <!-- Rect: x=430, y=131, w=190, h=48, right side -->
  <!-- ============================================================ -->
  <rect x="430" y="123" width="190" height="48" rx="6" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="525" y="143" class="node-text">Return 200 OK</text>
  <text x="525" y="158" class="node-sub">DAV headers</text>

  <!-- No arrow: Bottom vertex (245,187) -> Process1 top (245,212) -->
  <line x1="245" y1="187" x2="245" y2="212" class="arrow-no"/>
  <text x="255" y="203" class="no-label">No</text>

  <!-- ============================================================ -->
  <!-- NODE 3: PROCESS - auth_or_path_user -->
  <!-- Rect: x=120, y=212, w=250, h=48 -->
  <!-- ============================================================ -->
  <rect x="120" y="212" width="250" height="48" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="245" y="232" class="node-text">Call auth_or_path_user</text>
  <text x="245" y="247" class="node-sub">HTTP Basic Auth / {username} fallback</text>

  <!-- Arrow: Process1 bottom (245,260) -> Decision2 top (245,280) -->
  <line x1="245" y1="260" x2="245" y2="280" class="arrow"/>

  <!-- ============================================================ -->
  <!-- NODE 4: DECISION - User resolved? -->
  <!-- Diamond: cx=245, cy=320, dx=100, dy=40 -->
  <!-- Top: (245,280), Right: (345,320), Bottom: (245,360), Left: (145,320) -->
  <!-- ============================================================ -->
  <polygon points="245,280 345,320 245,360 145,320" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="245" y="322" class="decision-text">User</text>
  <text x="245" y="334" class="decision-text">resolved?</text>

  <!-- No arrow: Right vertex (345,320) -> Return 401 rect left (430,304) -->
  <line x1="345" y1="320" x2="427" y2="320" class="arrow-no"/>
  <text x="370" y="313" class="no-label">No</text>

  <!-- ============================================================ -->
  <!-- NODE 4a: Return 401 Unauthorized -->
  <!-- Rect: x=430, y=296, w=190, h=48 -->
  <!-- ============================================================ -->
  <rect x="430" y="296" width="190" height="48" rx="6" fill="url(#errorGrad)" filter="url(#shadow)"/>
  <text x="525" y="316" class="node-text">Return 401</text>
  <text x="525" y="331" class="node-sub">Unauthorized</text>

  <!-- Yes arrow: Bottom vertex (245,360) -> Process2 top (245,385) -->
  <line x1="245" y1="360" x2="245" y2="385" class="arrow-yes"/>
  <text x="255" y="376" class="yes-label">Yes</text>

  <!-- ============================================================ -->
  <!-- NODE 5: PROCESS - Look up calendar -->
  <!-- Rect: x=120, y=385, w=250, h=48 -->
  <!-- ============================================================ -->
  <rect x="120" y="385" width="250" height="48" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="245" y="405" class="node-text">Look up calendar</text>
  <text x="245" y="420" class="node-sub">by {calendar_id}</text>

  <!-- Arrow: Process2 bottom (245,433) -> Decision3 top (245,453) -->
  <line x1="245" y1="433" x2="245" y2="453" class="arrow"/>

  <!-- ============================================================ -->
  <!-- NODE 6: DECISION - Calendar exists & belongs to user? -->
  <!-- Diamond: cx=245, cy=493, dx=110, dy=40 -->
  <!-- Top: (245,453), Right: (355,493), Bottom: (245,533), Left: (135,493) -->
  <!-- ============================================================ -->
  <polygon points="245,453 355,493 245,533 135,493" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="245" y="490" class="decision-text">Calendar exists</text>
  <text x="245" y="502" class="decision-text">&amp; belongs to user?</text>

  <!-- No arrow: Right vertex (355,493) -> Return 403 rect left (430,469) -->
  <line x1="355" y1="493" x2="427" y2="493" class="arrow-no"/>
  <text x="377" y="486" class="no-label">No</text>

  <!-- ============================================================ -->
  <!-- NODE 6a: Return 403 Forbidden -->
  <!-- Rect: x=430, y=469, w=190, h=48 -->
  <!-- ============================================================ -->
  <rect x="430" y="469" width="190" height="48" rx="6" fill="url(#errorGrad)" filter="url(#shadow)"/>
  <text x="525" y="489" class="node-text">Return 403</text>
  <text x="525" y="504" class="node-sub">Forbidden</text>

  <!-- Yes arrow: Bottom vertex (245,533) -> Process3 top (245,558) -->
  <line x1="245" y1="533" x2="245" y2="558" class="arrow-yes"/>
  <text x="255" y="549" class="yes-label">Yes</text>

  <!-- ============================================================ -->
  <!-- NODE 7: PROCESS - Look up calendar object -->
  <!-- Rect: x=120, y=558, w=250, h=48 -->
  <!-- ============================================================ -->
  <rect x="120" y="558" width="250" height="48" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="245" y="578" class="node-text">Look up calendar object</text>
  <text x="245" y="593" class="node-sub">by {uid} in calendar</text>

  <!-- Arrow: Process3 bottom (245,606) -> Decision4 top (245,626) -->
  <line x1="245" y1="606" x2="245" y2="626" class="arrow"/>

  <!-- ============================================================ -->
  <!-- NODE 8: DECISION - Object found? -->
  <!-- Diamond: cx=245, cy=666, dx=100, dy=40 -->
  <!-- Top: (245,626), Right: (345,666), Bottom: (245,706), Left: (145,666) -->
  <!-- ============================================================ -->
  <polygon points="245,626 345,666 245,706 145,666" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="245" y="668" class="decision-text">Object</text>
  <text x="245" y="680" class="decision-text">found?</text>

  <!-- No arrow: Right vertex (345,666) -> Return 404 rect left (430,642) -->
  <line x1="345" y1="666" x2="427" y2="666" class="arrow-no"/>
  <text x="370" y="659" class="no-label">No</text>

  <!-- ============================================================ -->
  <!-- NODE 8a: Return 404 Not Found -->
  <!-- Rect: x=430, y=642, w=190, h=48 -->
  <!-- ============================================================ -->
  <rect x="430" y="642" width="190" height="48" rx="6" fill="url(#errorGrad)" filter="url(#shadow)"/>
  <text x="525" y="662" class="node-text">Return 404</text>
  <text x="525" y="677" class="node-sub">Not Found</text>

  <!-- Yes arrow: Bottom vertex (245,706) -> Return 200 rect top (245,736) -->
  <line x1="245" y1="706" x2="245" y2="736" class="arrow-yes"/>
  <text x="255" y="724" class="yes-label">Yes</text>

  <!-- ============================================================ -->
  <!-- NODE 9: Return 200 OK with body -->
  <!-- Rect: x=110, y=736, w=270, h=62 -->
  <!-- ============================================================ -->
  <rect x="110" y="736" width="270" height="62" rx="6" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="245" y="754" class="node-text">Return 200 OK</text>
  <text x="245" y="769" class="node-sub">Content-Type: text/calendar; charset=utf-8</text>
  <text x="245" y="782" class="node-sub">ETag: "{etag}" | Body: .ics data</text>

  <!-- Arrow: Return 200 bottom (245,798) -> END top (245,828) -->
  <line x1="245" y1="798" x2="245" y2="828" class="arrow"/>

  <!-- ============================================================ -->
  <!-- NODE 10: END -->
  <!-- Ellipse: cx=245, cy=854, rx=60, ry=22 -->
  <!-- ============================================================ -->
  <ellipse cx="245" cy="854" rx="60" ry="22" fill="url(#startGrad)" filter="url(#shadow)"/>
  <text x="245" y="859" class="node-text">END</text>

  <!-- ============================================================ -->
  <!-- LEGEND -->
  <!-- ============================================================ -->
  <g transform="translate(30, 885)">
    <ellipse cx="10" cy="-4" rx="8" ry="6" fill="url(#startGrad)"/>
    <text x="24" y="0" class="label-text">Start / End</text>

    <rect x="110" y="-10" width="14" height="12" rx="3" fill="url(#processGrad)"/>
    <text x="130" y="0" class="label-text">Process</text>

    <polygon points="215,-10 223,-4 215,2 207,-4" fill="url(#decisionGrad)"/>
    <text x="230" y="0" class="label-text">Decision</text>

    <rect x="310" y="-10" width="14" height="12" rx="3" fill="url(#endGrad)"/>
    <text x="330" y="0" class="label-text">Success</text>

    <rect x="400" y="-10" width="14" height="12" rx="3" fill="url(#errorGrad)"/>
    <text x="420" y="0" class="label-text">Error</text>

    <line x1="475" y1="-4" x2="495" y2="-4" class="arrow-yes"/>
    <text x="500" y="0" class="yes-label">Yes</text>

    <line x1="535" y1="-4" x2="555" y2="-4" class="arrow-no"/>
    <text x="560" y="0" class="no-label">No</text>
  </g>
</svg>
