<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 1300" width="900" height="1300">
  <defs>
    <style>
      .title { font: bold 20px sans-serif; fill: #333; }
      .node-text { font: bold 12px sans-serif; fill: #fff; text-anchor: middle; }
      .node-sub { font: 10px sans-serif; fill: rgba(255,255,255,0.85); text-anchor: middle; }
      .decision-text { font: bold 11px sans-serif; fill: #fff; text-anchor: middle; }
      .decision-sub { font: 9px sans-serif; fill: rgba(255,255,255,0.85); text-anchor: middle; }
      .label-text { font: bold 11px sans-serif; fill: #444; }
      .yes-label { font: bold 11px sans-serif; fill: #2d6a4f; }
      .no-label { font: bold 11px sans-serif; fill: #c1292e; }
      .arrow { stroke: #444; stroke-width: 1.8; marker-end: url(#arrowhead); }
      .arrow-yes { stroke: #2d6a4f; stroke-width: 1.8; marker-end: url(#arrowhead-yes); }
      .arrow-no { stroke: #c1292e; stroke-width: 1.8; marker-end: url(#arrowhead-no); }
      .tool-text { font: 10px monospace; fill: #fff; text-anchor: middle; }
    </style>

    <!-- Arrowhead markers -->
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#444"/>
    </marker>
    <marker id="arrowhead-yes" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2d6a4f"/>
    </marker>
    <marker id="arrowhead-no" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#c1292e"/>
    </marker>

    <!-- Drop shadow -->
    <filter id="shadow" x="-4%" y="-4%" width="108%" height="108%">
      <feDropShadow dx="1" dy="1" stdDeviation="2" flood-opacity="0.15"/>
    </filter>

    <!-- Node gradients -->
    <linearGradient id="startGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#5a9fd4"/>
      <stop offset="100%" stop-color="#4a90d9"/>
    </linearGradient>
    <linearGradient id="processGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#6b9def"/>
      <stop offset="100%" stop-color="#5b8def"/>
    </linearGradient>
    <linearGradient id="decisionGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#f0a14a"/>
      <stop offset="100%" stop-color="#e8913a"/>
    </linearGradient>
    <linearGradient id="endGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#2ebd6a"/>
      <stop offset="100%" stop-color="#27ae60"/>
    </linearGradient>
    <linearGradient id="errorGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#f05c4c"/>
      <stop offset="100%" stop-color="#e74c3c"/>
    </linearGradient>
  </defs>

  <!-- Background -->
  <rect width="900" height="1300" fill="#fafbfc" rx="8"/>

  <!-- Title -->
  <text x="450" y="35" class="title" text-anchor="middle">MCP Request Flow (Port 5233)</text>

  <!-- ============================================================ -->
  <!-- START: HTTP Request to /mcp  (ellipse, cy=72) -->
  <!-- top=46, bottom=98 -->
  <!-- ============================================================ -->
  <ellipse cx="350" cy="72" rx="120" ry="26" fill="url(#startGrad)" filter="url(#shadow)"/>
  <text x="350" y="70" class="node-text">HTTP Request to /mcp</text>
  <text x="350" y="83" class="node-sub">Port 5233</text>

  <!-- Arrow: START bottom (350,98) -> Decision 1 top (350,128) -->
  <line x1="350" y1="98" x2="350" y2="128" class="arrow"/>

  <!-- ============================================================ -->
  <!-- DECISION 1: Has Bearer token?  (cy=168, dy=40, dx=110) -->
  <!-- top=128, bottom=208, left=240, right=460 -->
  <!-- ============================================================ -->
  <polygon points="350,128 460,168 350,208 240,168" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="350" y="165" class="decision-text">Has Authorization:</text>
  <text x="350" y="177" class="decision-sub">Bearer {token} header?</text>

  <!-- No arrow: right vertex (460,168) -> 401 box -->
  <line x1="460" y1="168" x2="637" y2="168" class="arrow-no"/>
  <text x="475" y="161" class="no-label">No</text>

  <!-- Result: 401 Unauthorized (1) -->
  <rect x="640" y="150" width="210" height="36" rx="6" fill="url(#errorGrad)" filter="url(#shadow)"/>
  <text x="745" y="165" class="node-text">Return 401</text>
  <text x="745" y="178" class="node-sub">Unauthorized</text>

  <!-- Yes arrow: bottom vertex (350,208) -> Process: Hash token -->
  <line x1="350" y1="208" x2="350" y2="245" class="arrow-yes"/>
  <text x="360" y="224" class="yes-label">Yes</text>

  <!-- ============================================================ -->
  <!-- PROCESS: Hash token with Argon2id  (y=245, h=36) -->
  <!-- bottom=281 -->
  <!-- ============================================================ -->
  <rect x="245" y="245" width="210" height="36" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="350" y="260" class="node-text">Hash token with Argon2id</text>
  <text x="350" y="273" class="node-sub">Compute token_hash</text>

  <!-- Arrow: Process bottom (350,281) -> Process: Lookup -->
  <line x1="350" y1="281" x2="350" y2="305" class="arrow"/>

  <!-- ============================================================ -->
  <!-- PROCESS: Look up token_hash  (y=305, h=36) -->
  <!-- bottom=341 -->
  <!-- ============================================================ -->
  <rect x="245" y="305" width="210" height="36" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="350" y="320" class="node-text">Look up in mcp_tokens</text>
  <text x="350" y="333" class="node-sub">Match token_hash to user_id</text>

  <!-- Arrow: Process bottom (350,341) -> Decision 2 top -->
  <line x1="350" y1="341" x2="350" y2="378" class="arrow"/>

  <!-- ============================================================ -->
  <!-- DECISION 2: Token valid?  (cy=418, dy=40, dx=110) -->
  <!-- top=378, bottom=458, left=240, right=460 -->
  <!-- ============================================================ -->
  <polygon points="350,378 460,418 350,458 240,418" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="350" y="415" class="decision-text">Token valid?</text>
  <text x="350" y="427" class="decision-sub">Exists and not expired</text>

  <!-- No arrow: right vertex (460,418) -> 401 box -->
  <line x1="460" y1="418" x2="637" y2="418" class="arrow-no"/>
  <text x="475" y="411" class="no-label">No</text>

  <!-- Result: 401 Unauthorized (2) -->
  <rect x="640" y="400" width="210" height="36" rx="6" fill="url(#errorGrad)" filter="url(#shadow)"/>
  <text x="745" y="415" class="node-text">Return 401</text>
  <text x="745" y="428" class="node-sub">Unauthorized</text>

  <!-- Yes arrow: bottom vertex (350,458) -> Decision 3 top -->
  <line x1="350" y1="458" x2="350" y2="498" class="arrow-yes"/>
  <text x="360" y="474" class="yes-label">Yes</text>

  <!-- ============================================================ -->
  <!-- DECISION 3: HTTP Method?  (cy=538, dy=40, dx=100) -->
  <!-- top=498, bottom=578, left=250, right=450 -->
  <!-- ============================================================ -->
  <polygon points="350,498 450,538 350,578 250,538" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="350" y="535" class="decision-text">HTTP</text>
  <text x="350" y="547" class="decision-text">Method?</text>

  <!-- GET arrow: left vertex (250,538) -> GET process box top -->
  <path d="M250,538 L115,538 L115,555" class="arrow" fill="none"/>
  <text x="225" y="531" class="label-text">GET</text>

  <!-- GET process box (y=555, h=48, bottom=603) -->
  <rect x="30" y="555" width="170" height="48" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="115" y="574" class="node-text">Streamable HTTP</text>
  <text x="115" y="588" class="node-sub">Long-lived connection</text>

  <!-- GET box arrow: down then right to Parse JSON-RPC left edge -->
  <path d="M115,603 L115,643 L245,643" class="arrow" fill="none"/>

  <!-- DELETE arrow: right vertex (450,538) -> DELETE result box -->
  <line x1="450" y1="538" x2="637" y2="538" class="arrow"/>
  <text x="465" y="531" class="label-text">DELETE</text>

  <!-- DELETE result box: Close session (y=520, h=36) -->
  <rect x="640" y="520" width="210" height="36" rx="6" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="745" y="535" class="node-text">Close/Destroy Session</text>
  <text x="745" y="548" class="node-sub">Return 200 OK</text>

  <!-- POST arrow: bottom vertex (350,578) -> Parse JSON-RPC top -->
  <line x1="350" y1="578" x2="350" y2="625" class="arrow"/>
  <text x="360" y="593" class="label-text">POST</text>

  <!-- ============================================================ -->
  <!-- PROCESS: Parse JSON-RPC  (y=625, h=36) -->
  <!-- bottom=661 -->
  <!-- ============================================================ -->
  <rect x="245" y="625" width="210" height="36" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="350" y="640" class="node-text">Parse JSON-RPC 2.0</text>
  <text x="350" y="653" class="node-sub">Request body</text>

  <!-- Arrow: Parse bottom (350,661) -> Decision 4 top -->
  <line x1="350" y1="661" x2="350" y2="698" class="arrow"/>

  <!-- ============================================================ -->
  <!-- DECISION 4: JSON-RPC method?  (cy=738, dy=40, dx=110) -->
  <!-- top=698, bottom=778, left=240, right=460 -->
  <!-- ============================================================ -->
  <polygon points="350,698 460,738 350,778 240,738" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="350" y="735" class="decision-text">JSON-RPC</text>
  <text x="350" y="747" class="decision-text">method?</text>

  <!-- Protocol methods arrow: right vertex (460,738) -> result box -->
  <line x1="460" y1="738" x2="507" y2="738" class="arrow"/>
  <text x="470" y="731" class="label-text">Protocol</text>

  <!-- Protocol methods result box -->
  <rect x="510" y="706" width="370" height="64" rx="6" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="695" y="722" class="node-text">Return Protocol Response</text>
  <text x="695" y="737" class="node-sub">initialize: server info (name, version, capabilities)</text>
  <text x="695" y="749" class="node-sub">ping: pong | notifications/initialized: ack</text>
  <text x="695" y="761" class="node-sub">tools/list: 12 tool schemas</text>

  <!-- tools/call arrow: bottom vertex (350,778) -> Process: Extract tool -->
  <line x1="350" y1="778" x2="350" y2="810" class="arrow"/>
  <text x="328" y="800" class="label-text" text-anchor="end">tools/call</text>

  <!-- ============================================================ -->
  <!-- PROCESS: Extract tool name  (y=810, h=36) -->
  <!-- bottom=846 -->
  <!-- ============================================================ -->
  <rect x="245" y="810" width="210" height="36" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="350" y="825" class="node-text">Extract Tool Name</text>
  <text x="350" y="838" class="node-sub">Parse params: name + arguments</text>

  <!-- Arrow: Extract bottom (350,846) -> Tool dispatch box -->
  <line x1="350" y1="846" x2="350" y2="870" class="arrow"/>

  <!-- ============================================================ -->
  <!-- PROCESS: Tool dispatch (wide box showing all 12 tools) -->
  <!-- y=870, h=80 -->
  <!-- bottom=950 -->
  <!-- ============================================================ -->
  <rect x="100" y="870" width="500" height="80" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="350" y="888" class="node-text">Dispatch to Tool Handler</text>
  <text x="210" y="906" class="tool-text">Calendar: list | get</text>
  <text x="210" y="919" class="tool-text">create | delete</text>
  <text x="350" y="906" class="tool-text">Event: create | get</text>
  <text x="350" y="919" class="tool-text">update | delete | query</text>
  <text x="490" y="906" class="tool-text">Sharing: share</text>
  <text x="490" y="919" class="tool-text">unshare | list_shared</text>

  <!-- Divider lines inside tool box -->
  <line x1="280" y1="896" x2="280" y2="940" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
  <line x1="420" y1="896" x2="420" y2="940" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>

  <!-- Arrow: Tool dispatch bottom (350,950) -> Process: Execute -->
  <line x1="350" y1="950" x2="350" y2="975" class="arrow"/>

  <!-- ============================================================ -->
  <!-- PROCESS: Execute with user_id context  (y=975, h=36) -->
  <!-- bottom=1011 -->
  <!-- ============================================================ -->
  <rect x="245" y="975" width="210" height="36" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="350" y="990" class="node-text">Execute Tool</text>
  <text x="350" y="1003" class="node-sub">With user_id context</text>

  <!-- Arrow: Execute bottom (350,1011) -> Decision 5 top -->
  <line x1="350" y1="1011" x2="350" y2="1045" class="arrow"/>

  <!-- ============================================================ -->
  <!-- DECISION 5: Tool succeeded?  (cy=1085, dy=40, dx=100) -->
  <!-- top=1045, bottom=1125, left=250, right=450 -->
  <!-- ============================================================ -->
  <polygon points="350,1045 450,1085 350,1125 250,1085" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="350" y="1082" class="decision-text">Tool</text>
  <text x="350" y="1094" class="decision-text">succeeded?</text>

  <!-- No arrow: right vertex (450,1085) -> error result box -->
  <line x1="450" y1="1085" x2="637" y2="1085" class="arrow-no"/>
  <text x="465" y="1078" class="no-label">No</text>

  <!-- Result: JSON-RPC error -->
  <rect x="640" y="1067" width="210" height="36" rx="6" fill="url(#errorGrad)" filter="url(#shadow)"/>
  <text x="745" y="1082" class="node-text">JSON-RPC Error</text>
  <text x="745" y="1095" class="node-sub">Error response with details</text>

  <!-- Yes arrow: left vertex (250,1085) -> success result box right edge (213) -->
  <line x1="250" y1="1085" x2="213" y2="1085" class="arrow-yes"/>
  <text x="237" y="1078" class="yes-label">Yes</text>

  <!-- Result: JSON-RPC success (x=10, w=200, right edge=210) -->
  <rect x="10" y="1067" width="200" height="36" rx="6" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="110" y="1082" class="node-text">JSON-RPC Result</text>
  <text x="110" y="1095" class="node-sub">Success response with data</text>

  <!-- ============================================================ -->
  <!-- LEGEND -->
  <!-- ============================================================ -->
  <g transform="translate(30, 1160)">
    <text x="0" y="0" class="label-text" style="font-size:13px">Legend</text>

    <!-- Start terminal -->
    <ellipse cx="25" cy="25" rx="20" ry="12" fill="url(#startGrad)"/>
    <text x="55" y="30" class="label-text">Start / End terminal</text>

    <!-- Decision -->
    <polygon points="25,50 40,62 25,74 10,62" fill="url(#decisionGrad)"/>
    <text x="55" y="67" class="label-text">Decision</text>

    <!-- Process -->
    <rect x="5" y="85" width="40" height="18" rx="4" fill="url(#processGrad)"/>
    <text x="55" y="99" class="label-text">Process step</text>

    <!-- Success result -->
    <rect x="270" y="19" width="40" height="18" rx="4" fill="url(#endGrad)"/>
    <text x="320" y="33" class="label-text">Success response</text>

    <!-- Error result -->
    <rect x="270" y="49" width="40" height="18" rx="4" fill="url(#errorGrad)"/>
    <text x="320" y="63" class="label-text">Error response</text>

    <!-- Arrow legend -->
    <line x1="540" y1="28" x2="590" y2="28" class="arrow-yes"/>
    <text x="600" y="33" class="yes-label">Yes / true path</text>

    <line x1="540" y1="58" x2="590" y2="58" class="arrow-no"/>
    <text x="600" y="63" class="no-label">No / false path</text>

    <line x1="540" y1="88" x2="590" y2="88" class="arrow"/>
    <text x="600" y="93" class="label-text">Main flow / continue</text>
  </g>
</svg>