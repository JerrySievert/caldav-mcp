<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600 800" width="600" height="800">
  <defs>
    <style>
      .title { font: bold 20px sans-serif; fill: #333; }
      .node-text { font: bold 12px sans-serif; fill: #fff; text-anchor: middle; }
      .node-sub { font: 10px sans-serif; fill: rgba(255,255,255,0.85); text-anchor: middle; }
      .decision-text { font: bold 11px sans-serif; fill: #fff; text-anchor: middle; }
      .label-text { font: bold 11px sans-serif; fill: #444; }
      .yes-label { font: bold 11px sans-serif; fill: #2d6a4f; }
      .no-label { font: bold 11px sans-serif; fill: #c1292e; }
      .arrow { stroke: #444; stroke-width: 1.8; marker-end: url(#arrowhead); }
      .arrow-yes { stroke: #2d6a4f; stroke-width: 1.8; marker-end: url(#arrowhead-yes); }
      .arrow-no { stroke: #c1292e; stroke-width: 1.8; marker-end: url(#arrowhead-no); }
    </style>

    <!-- Arrowhead markers -->
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#444"/>
    </marker>
    <marker id="arrowhead-yes" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2d6a4f"/>
    </marker>
    <marker id="arrowhead-no" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#c1292e"/>
    </marker>

    <!-- Drop shadow -->
    <filter id="shadow" x="-4%" y="-4%" width="108%" height="108%">
      <feDropShadow dx="1" dy="1" stdDeviation="2" flood-opacity="0.15"/>
    </filter>

    <!-- Node gradients -->
    <linearGradient id="startGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#5a9fd4"/>
      <stop offset="100%" stop-color="#4a90d9"/>
    </linearGradient>
    <linearGradient id="processGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#6b9def"/>
      <stop offset="100%" stop-color="#5b8def"/>
    </linearGradient>
    <linearGradient id="decisionGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#f0a14a"/>
      <stop offset="100%" stop-color="#e8913a"/>
    </linearGradient>
    <linearGradient id="endGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#2ebd6a"/>
      <stop offset="100%" stop-color="#27ae60"/>
    </linearGradient>
    <linearGradient id="errorGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#f05c4c"/>
      <stop offset="100%" stop-color="#e74c3c"/>
    </linearGradient>
  </defs>

  <!-- Background -->
  <rect width="600" height="800" fill="#fafbfc" rx="8"/>

  <!-- Title -->
  <text x="300" y="35" class="title" text-anchor="middle">MKCALENDAR Flow</text>

  <!-- ============================================================ -->
  <!-- Node 1: START - MKCALENDAR Request                           -->
  <!-- Ellipse center: (250, 70), rx=120, ry=26                    -->
  <!-- ============================================================ -->
  <ellipse cx="250" cy="70" rx="120" ry="26" fill="url(#startGrad)" filter="url(#shadow)"/>
  <text x="250" y="70" class="node-text" dy="1">MKCALENDAR Request</text>
  <text x="250" y="83" class="node-sub">/caldav/users/{user}/{cal}/</text>

  <!-- Arrow: START bottom (250,96) -> Decision 1 top (250,119) -->
  <line x1="250" y1="96" x2="250" y2="119" class="arrow"/>

  <!-- ============================================================ -->
  <!-- Node 2: Decision - Is method OPTIONS?                        -->
  <!-- Center: (250, 155), DX=90, DY=36                            -->
  <!-- Vertices: top(250,119) right(340,155) bottom(250,191) left(160,155) -->
  <!-- ============================================================ -->
  <polygon points="250,119 340,155 250,191 160,155" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="250" y="153" class="decision-text">Is method</text>
  <text x="250" y="165" class="decision-text">OPTIONS?</text>

  <!-- Yes branch: right vertex (340,155) -> right to Return 200 rect -->
  <line x1="340" y1="155" x2="457" y2="155" class="arrow-yes"/>
  <text x="352" y="148" class="yes-label">Yes</text>

  <!-- Return 200 with DAV headers -->
  <!-- Rect: x=460, y=137, w=120, h=36 -->
  <rect x="460" y="137" width="120" height="36" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="520" y="152" class="node-text" style="font-size:10px">Return 200 with</text>
  <text x="520" y="163" class="node-text" style="font-size:10px">DAV headers</text>

  <!-- Arrow: Return 200 bottom -> END (right branch) -->
  <line x1="520" y1="173" x2="520" y2="190" class="arrow"/>

  <!-- END ellipse (right branch): cx=520, cy=212, rx=40, ry=18 -->
  <ellipse cx="520" cy="212" rx="40" ry="18" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="520" y="217" class="node-text" style="font-size:11px">END</text>

  <!-- No branch: bottom vertex (250,191) -> Process auth -->
  <line x1="250" y1="191" x2="250" y2="223" class="arrow-no"/>
  <text x="260" y="206" class="no-label">No</text>

  <!-- ============================================================ -->
  <!-- Node 3: Process - Call auth_or_path_user                     -->
  <!-- Rect: x=140, y=223, w=220, h=48                            -->
  <!-- ============================================================ -->
  <rect x="140" y="223" width="220" height="48" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="250" y="244" class="node-text">Call auth_or_path_user</text>
  <text x="250" y="259" class="node-sub">HTTP Basic Auth, fallback to path</text>

  <!-- Arrow: Process auth bottom (250,271) -> Decision 2 top (250,293) -->
  <line x1="250" y1="271" x2="250" y2="293" class="arrow"/>

  <!-- ============================================================ -->
  <!-- Node 4: Decision - User resolved?                            -->
  <!-- Center: (250, 329), DX=90, DY=36                            -->
  <!-- Vertices: top(250,293) right(340,329) bottom(250,365) left(160,329) -->
  <!-- ============================================================ -->
  <polygon points="250,293 340,329 250,365 160,329" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="250" y="333" class="decision-text">User resolved?</text>

  <!-- No branch: right vertex (340,329) -> Return 401 -->
  <line x1="340" y1="329" x2="457" y2="329" class="arrow-no"/>
  <text x="352" y="322" class="no-label">No</text>

  <!-- Return 401 Unauthorized -->
  <!-- Rect: x=460, y=311, w=120, h=36 -->
  <rect x="460" y="311" width="120" height="36" rx="6" fill="url(#errorGrad)" filter="url(#shadow)"/>
  <text x="520" y="326" class="node-text" style="font-size:10px">Return 401</text>
  <text x="520" y="337" class="node-text" style="font-size:10px">Unauthorized</text>

  <!-- Arrow: Return 401 bottom -> END (right branch 2) -->
  <line x1="520" y1="347" x2="520" y2="364" class="arrow"/>

  <!-- END ellipse (right branch 2): cx=520, cy=384, rx=40, ry=18 -->
  <ellipse cx="520" cy="384" rx="40" ry="18" fill="url(#errorGrad)" filter="url(#shadow)"/>
  <text x="520" y="389" class="node-text" style="font-size:11px">END</text>

  <!-- Yes branch: bottom vertex (250,365) -> Parse XML body -->
  <line x1="250" y1="365" x2="250" y2="397" class="arrow-yes"/>
  <text x="260" y="380" class="yes-label">Yes</text>

  <!-- ============================================================ -->
  <!-- Node 5: Process - Parse XML body                             -->
  <!-- Rect: x=150, y=397, w=200, h=36                            -->
  <!-- ============================================================ -->
  <rect x="150" y="397" width="200" height="36" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="250" y="415" class="node-text">Parse XML body (if present)</text>
  <text x="250" y="427" class="node-sub"></text>

  <!-- Arrow: Parse XML bottom (250,433) -> Extract props -->
  <line x1="250" y1="433" x2="250" y2="457" class="arrow"/>

  <!-- ============================================================ -->
  <!-- Node 6: Process - Extract displayname and calendar-color     -->
  <!-- Rect: x=115, y=457, w=270, h=48                            -->
  <!-- ============================================================ -->
  <rect x="115" y="457" width="270" height="48" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="250" y="477" class="node-text">Extract displayname, calendar-color</text>
  <text x="250" y="493" class="node-sub">Defaults: calendar_id as name, #0E61B9</text>

  <!-- Arrow: Extract props bottom (250,505) -> Generate ID -->
  <line x1="250" y1="505" x2="250" y2="529" class="arrow"/>

  <!-- ============================================================ -->
  <!-- Node 7: Process - Generate new calendar ID                   -->
  <!-- Rect: x=120, y=529, w=260, h=36                            -->
  <!-- ============================================================ -->
  <rect x="120" y="529" width="260" height="36" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="250" y="551" class="node-text">Generate new calendar ID (UUID v7)</text>

  <!-- Arrow: Generate ID bottom (250,565) -> Create calendar -->
  <line x1="250" y1="565" x2="250" y2="589" class="arrow"/>

  <!-- ============================================================ -->
  <!-- Node 8: Process - Create calendar in database                -->
  <!-- Rect: x=100, y=589, w=300, h=48                            -->
  <!-- ============================================================ -->
  <rect x="100" y="589" width="300" height="48" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="250" y="609" class="node-text">Create calendar in database</text>
  <text x="250" y="625" class="node-sub">owner_id, name, color, tz=UTC, ctag, sync_token</text>

  <!-- Arrow: Create calendar bottom (250,637) -> Return 201 -->
  <line x1="250" y1="637" x2="250" y2="665" class="arrow"/>

  <!-- ============================================================ -->
  <!-- Node 9: END - Return 201 Created                            -->
  <!-- Ellipse center: (250, 691), rx=100, ry=26                  -->
  <!-- ============================================================ -->
  <ellipse cx="250" cy="691" rx="100" ry="26" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="250" y="688" class="node-text">Return 201 Created</text>
  <text x="250" y="703" class="node-sub">Calendar created</text>

  <!-- ============================================================ -->
  <!-- Legend                                                        -->
  <!-- ============================================================ -->
  <g transform="translate(30, 738)">
    <text x="0" y="12" class="label-text" style="font-size:10px">Legend:</text>
    <ellipse cx="70" cy="8" rx="16" ry="8" fill="url(#startGrad)"/>
    <text x="95" y="12" class="label-text" style="font-size:10px">Start/End</text>
    <rect x="140" y="0" width="24" height="16" rx="3" fill="url(#processGrad)"/>
    <text x="172" y="12" class="label-text" style="font-size:10px">Process</text>
    <polygon points="230,0 242,8 230,16 218,8" fill="url(#decisionGrad)"/>
    <text x="250" y="12" class="label-text" style="font-size:10px">Decision</text>
    <rect x="300" y="0" width="24" height="16" rx="3" fill="url(#errorGrad)"/>
    <text x="332" y="12" class="label-text" style="font-size:10px">Error</text>
    <line x1="370" y1="8" x2="395" y2="8" class="arrow-yes"/>
    <text x="403" y="12" class="yes-label" style="font-size:10px">Yes</text>
    <line x1="430" y1="8" x2="455" y2="8" class="arrow-no"/>
    <text x="463" y="12" class="no-label" style="font-size:10px">No</text>
    <line x1="490" y1="8" x2="515" y2="8" class="arrow"/>
    <text x="523" y="12" class="label-text" style="font-size:10px">Flow</text>
  </g>
</svg>
