<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1300 850" width="1300" height="850">
  <defs>
    <style>
      .title { font: bold 20px sans-serif; fill: #333; }
      .subtitle { font: 13px sans-serif; fill: #777; }
      .table-header { font: bold 13px sans-serif; fill: #fff; text-anchor: middle; }
      .col { font: 12px monospace; fill: #333; }
      .col-type { font: 11px monospace; fill: #888; text-anchor: end; }
      .pk-icon { font: bold 10px sans-serif; fill: #e8913a; }
      .fk-icon { font: bold 10px sans-serif; fill: #5b8def; }
      .constraint-tag { font: bold 8px sans-serif; fill: #999; }
      .relation-label { font: 11px sans-serif; fill: #666; }
      .group-label { font: bold 14px sans-serif; fill: #444; }
      .arrow { stroke: #999; stroke-width: 1.5; fill: none; }
      .legend-text { font: 12px sans-serif; fill: #555; }
      .legend-title { font: bold 12px sans-serif; fill: #444; }
      .unique-note { font: 10px monospace; fill: #999; font-style: italic; }
    </style>

    <filter id="shadow" x="-4%" y="-4%" width="108%" height="108%">
      <feDropShadow dx="1" dy="1" stdDeviation="2" flood-opacity="0.12"/>
    </filter>

    <linearGradient id="tableGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#6b9def"/>
      <stop offset="100%" stop-color="#5b8def"/>
    </linearGradient>
    <linearGradient id="tableGrad2" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#6bc785"/>
      <stop offset="100%" stop-color="#5ab870"/>
    </linearGradient>
    <linearGradient id="tableGrad3" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#b07de8"/>
      <stop offset="100%" stop-color="#9b6dd0"/>
    </linearGradient>

    <marker id="one" markerWidth="12" markerHeight="12" refX="12" refY="6" orient="auto">
      <line x1="10" y1="2" x2="10" y2="10" stroke="#999" stroke-width="1.5"/>
    </marker>
    <marker id="many" markerWidth="16" markerHeight="12" refX="14" refY="6" orient="auto">
      <path d="M2,6 L14,2 M2,6 L14,10 M14,2 L14,10" stroke="#999" stroke-width="1.2" fill="none"/>
    </marker>
  </defs>

  <!-- Background -->
  <rect width="1300" height="850" fill="#fafbfc" rx="8"/>

  <!-- Title -->
  <text x="650" y="33" class="title" text-anchor="middle">CalDAV Server - Database Schema</text>
  <text x="650" y="50" class="subtitle" text-anchor="middle">SQLite storage  |  UUID v7 primary keys  |  6 tables</text>

  <!-- =========================================== -->
  <!-- Domain group: Auth (users, mcp_tokens)      -->
  <!-- =========================================== -->
  <rect x="28" y="62" width="318" height="528" rx="10" fill="none"
        stroke="#c5d0de" stroke-width="1.5" stroke-dasharray="8,4"/>
  <text x="42" y="80" class="group-label">Auth Domain</text>

  <!-- =========================================== -->
  <!-- Domain group: Calendar                      -->
  <!-- =========================================== -->
  <rect x="378" y="62" width="898" height="776" rx="10" fill="none"
        stroke="#c5d0de" stroke-width="1.5" stroke-dasharray="8,4"/>
  <text x="392" y="80" class="group-label">Calendar Domain</text>


  <!-- ======================================================= -->
  <!-- TABLE: users  (x=50, y=95, w=270, 5 rows, h=160)       -->
  <!-- Row y formula: baseY + 32 + rowIndex*24 + 16            -->
  <!-- ======================================================= -->
  <g filter="url(#shadow)">
    <rect x="50" y="95" width="270" height="160" rx="6" fill="#fff" stroke="#ddd" stroke-width="1"/>
    <rect x="50" y="95" width="270" height="32" rx="6" fill="url(#tableGrad)"/>
    <rect x="50" y="115" width="270" height="12" fill="url(#tableGrad)"/>
    <text x="185" y="117" class="table-header">users</text>
    <line x1="50" y1="127" x2="320" y2="127" stroke="#e8e8e8" stroke-width="1"/>

    <!-- alternating row stripes -->
    <rect x="51" y="127" width="268" height="24" fill="#f8faff"/>
    <rect x="51" y="175" width="268" height="24" fill="#f8faff"/>

    <!-- Row 0: id (y=143) -->
    <text x="60" y="145" class="pk-icon">PK</text>
    <text x="82" y="145" class="col">id</text>
    <text x="310" y="145" class="col-type">TEXT</text>

    <!-- Row 1: username (y=167) -->
    <text x="82" y="169" class="col">username</text>
    <text x="310" y="169" class="col-type">TEXT UNIQUE NN</text>

    <!-- Row 2: email (y=191) -->
    <text x="82" y="193" class="col">email</text>
    <text x="310" y="193" class="col-type">TEXT UNIQUE</text>

    <!-- Row 3: password_hash (y=215) -->
    <text x="82" y="217" class="col">password_hash</text>
    <text x="310" y="217" class="col-type">TEXT NN</text>

    <!-- Row 4: created_at (y=239) -->
    <text x="82" y="241" class="col">created_at</text>
    <text x="310" y="241" class="col-type">TIMESTAMP</text>
  </g>


  <!-- ======================================================= -->
  <!-- TABLE: mcp_tokens  (x=50, y=325, w=270, 6 rows, h=184) -->
  <!-- ======================================================= -->
  <g filter="url(#shadow)">
    <rect x="50" y="325" width="270" height="184" rx="6" fill="#fff" stroke="#ddd" stroke-width="1"/>
    <rect x="50" y="325" width="270" height="32" rx="6" fill="url(#tableGrad2)"/>
    <rect x="50" y="345" width="270" height="12" fill="url(#tableGrad2)"/>
    <text x="185" y="347" class="table-header">mcp_tokens</text>
    <line x1="50" y1="357" x2="320" y2="357" stroke="#e8e8e8" stroke-width="1"/>

    <rect x="51" y="357" width="268" height="24" fill="#f5faf6"/>
    <rect x="51" y="405" width="268" height="24" fill="#f5faf6"/>
    <rect x="51" y="453" width="268" height="24" fill="#f5faf6"/>

    <!-- Row 0: id -->
    <text x="60" y="375" class="pk-icon">PK</text>
    <text x="82" y="375" class="col">id</text>
    <text x="310" y="375" class="col-type">TEXT</text>

    <!-- Row 1: user_id -->
    <text x="60" y="399" class="fk-icon">FK</text>
    <text x="82" y="399" class="col">user_id</text>
    <text x="310" y="399" class="col-type">TEXT</text>

    <!-- Row 2: token_hash -->
    <text x="82" y="423" class="col">token_hash</text>
    <text x="310" y="423" class="col-type">TEXT NN</text>

    <!-- Row 3: name -->
    <text x="82" y="447" class="col">name</text>
    <text x="310" y="447" class="col-type">TEXT NN</text>

    <!-- Row 4: created_at -->
    <text x="82" y="471" class="col">created_at</text>
    <text x="310" y="471" class="col-type">TIMESTAMP</text>

    <!-- Row 5: expires_at -->
    <text x="82" y="495" class="col">expires_at</text>
    <text x="310" y="495" class="col-type">TIMESTAMP NULL</text>
  </g>


  <!-- ======================================================= -->
  <!-- TABLE: calendars  (x=440, y=95, w=280, 10 rows, h=280) -->
  <!-- ======================================================= -->
  <g filter="url(#shadow)">
    <rect x="440" y="95" width="280" height="280" rx="6" fill="#fff" stroke="#ddd" stroke-width="1"/>
    <rect x="440" y="95" width="280" height="32" rx="6" fill="url(#tableGrad)"/>
    <rect x="440" y="115" width="280" height="12" fill="url(#tableGrad)"/>
    <text x="580" y="117" class="table-header">calendars</text>
    <line x1="440" y1="127" x2="720" y2="127" stroke="#e8e8e8" stroke-width="1"/>

    <rect x="441" y="127" width="278" height="24" fill="#f8faff"/>
    <rect x="441" y="175" width="278" height="24" fill="#f8faff"/>
    <rect x="441" y="223" width="278" height="24" fill="#f8faff"/>
    <rect x="441" y="271" width="278" height="24" fill="#f8faff"/>
    <rect x="441" y="319" width="278" height="24" fill="#f8faff"/>

    <!-- Row 0: id -->
    <text x="450" y="145" class="pk-icon">PK</text>
    <text x="472" y="145" class="col">id</text>
    <text x="710" y="145" class="col-type">TEXT</text>

    <!-- Row 1: owner_id -->
    <text x="450" y="169" class="fk-icon">FK</text>
    <text x="472" y="169" class="col">owner_id</text>
    <text x="710" y="169" class="col-type">TEXT</text>

    <!-- Row 2: name -->
    <text x="472" y="193" class="col">name</text>
    <text x="710" y="193" class="col-type">TEXT NN</text>

    <!-- Row 3: description -->
    <text x="472" y="217" class="col">description</text>
    <text x="710" y="217" class="col-type">TEXT</text>

    <!-- Row 4: color -->
    <text x="472" y="241" class="col">color</text>
    <text x="710" y="241" class="col-type">TEXT</text>

    <!-- Row 5: timezone -->
    <text x="472" y="265" class="col">timezone</text>
    <text x="710" y="265" class="col-type">TEXT</text>

    <!-- Row 6: ctag -->
    <text x="472" y="289" class="col">ctag</text>
    <text x="710" y="289" class="col-type">TEXT</text>

    <!-- Row 7: sync_token -->
    <text x="472" y="313" class="col">sync_token</text>
    <text x="710" y="313" class="col-type">TEXT</text>

    <!-- Row 8: created_at -->
    <text x="472" y="337" class="col">created_at</text>
    <text x="710" y="337" class="col-type">TIMESTAMP</text>

    <!-- Row 9: updated_at -->
    <text x="472" y="361" class="col">updated_at</text>
    <text x="710" y="361" class="col-type">TIMESTAMP</text>
  </g>


  <!-- ======================================================= -->
  <!-- TABLE: calendar_objects (x=400, y=435, w=290, 11 rows)  -->
  <!-- h = 32 + 11*24 + 8 = 304                                -->
  <!-- ======================================================= -->
  <g filter="url(#shadow)">
    <rect x="400" y="435" width="290" height="304" rx="6" fill="#fff" stroke="#ddd" stroke-width="1"/>
    <rect x="400" y="435" width="290" height="32" rx="6" fill="url(#tableGrad)"/>
    <rect x="400" y="455" width="290" height="12" fill="url(#tableGrad)"/>
    <text x="545" y="457" class="table-header">calendar_objects</text>
    <line x1="400" y1="467" x2="690" y2="467" stroke="#e8e8e8" stroke-width="1"/>

    <rect x="401" y="467" width="288" height="24" fill="#f8faff"/>
    <rect x="401" y="515" width="288" height="24" fill="#f8faff"/>
    <rect x="401" y="563" width="288" height="24" fill="#f8faff"/>
    <rect x="401" y="611" width="288" height="24" fill="#f8faff"/>
    <rect x="401" y="659" width="288" height="24" fill="#f8faff"/>
    <rect x="401" y="707" width="288" height="24" fill="#f8faff"/>

    <!-- Row 0: id -->
    <text x="410" y="485" class="pk-icon">PK</text>
    <text x="432" y="485" class="col">id</text>
    <text x="680" y="485" class="col-type">TEXT</text>

    <!-- Row 1: calendar_id -->
    <text x="410" y="509" class="fk-icon">FK</text>
    <text x="432" y="509" class="col">calendar_id</text>
    <text x="680" y="509" class="col-type">TEXT</text>

    <!-- Row 2: uid -->
    <text x="432" y="533" class="col">uid</text>
    <text x="680" y="533" class="col-type">TEXT NN</text>

    <!-- Row 3: etag -->
    <text x="432" y="557" class="col">etag</text>
    <text x="680" y="557" class="col-type">TEXT NN</text>

    <!-- Row 4: ical_data -->
    <text x="432" y="581" class="col">ical_data</text>
    <text x="680" y="581" class="col-type">TEXT NN</text>

    <!-- Row 5: component_type -->
    <text x="432" y="605" class="col">component_type</text>
    <text x="680" y="605" class="col-type">TEXT</text>

    <!-- Row 6: dtstart -->
    <text x="432" y="629" class="col">dtstart</text>
    <text x="680" y="629" class="col-type">TEXT</text>

    <!-- Row 7: dtend -->
    <text x="432" y="653" class="col">dtend</text>
    <text x="680" y="653" class="col-type">TEXT</text>

    <!-- Row 8: summary -->
    <text x="432" y="677" class="col">summary</text>
    <text x="680" y="677" class="col-type">TEXT</text>

    <!-- Row 9: created_at -->
    <text x="432" y="701" class="col">created_at</text>
    <text x="680" y="701" class="col-type">TIMESTAMP</text>

    <!-- Row 10: updated_at -->
    <text x="432" y="725" class="col">updated_at</text>
    <text x="680" y="725" class="col-type">TIMESTAMP</text>
  </g>


  <!-- ======================================================= -->
  <!-- TABLE: calendar_shares (x=790, y=95, w=270, h=192)      -->
  <!-- 5 columns + UNIQUE constraint row = 6 visual rows       -->
  <!-- ======================================================= -->
  <g filter="url(#shadow)">
    <rect x="790" y="95" width="270" height="192" rx="6" fill="#fff" stroke="#ddd" stroke-width="1"/>
    <rect x="790" y="95" width="270" height="32" rx="6" fill="url(#tableGrad3)"/>
    <rect x="790" y="115" width="270" height="12" fill="url(#tableGrad3)"/>
    <text x="925" y="117" class="table-header">calendar_shares</text>
    <line x1="790" y1="127" x2="1060" y2="127" stroke="#e8e8e8" stroke-width="1"/>

    <rect x="791" y="127" width="268" height="24" fill="#f9f5ff"/>
    <rect x="791" y="175" width="268" height="24" fill="#f9f5ff"/>
    <rect x="791" y="223" width="268" height="24" fill="#f9f5ff"/>

    <!-- Row 0: id -->
    <text x="800" y="145" class="pk-icon">PK</text>
    <text x="822" y="145" class="col">id</text>
    <text x="1050" y="145" class="col-type">TEXT</text>

    <!-- Row 1: calendar_id -->
    <text x="800" y="169" class="fk-icon">FK</text>
    <text x="822" y="169" class="col">calendar_id</text>
    <text x="1050" y="169" class="col-type">TEXT</text>

    <!-- Row 2: user_id -->
    <text x="800" y="193" class="fk-icon">FK</text>
    <text x="822" y="193" class="col">user_id</text>
    <text x="1050" y="193" class="col-type">TEXT</text>

    <!-- Row 3: permission -->
    <text x="822" y="217" class="col">permission</text>
    <text x="1050" y="217" class="col-type">TEXT</text>

    <!-- Row 4: created_at -->
    <text x="822" y="241" class="col">created_at</text>
    <text x="1050" y="241" class="col-type">TIMESTAMP</text>

    <!-- Constraint separator and note -->
    <line x1="790" y1="255" x2="1060" y2="255" stroke="#e8e8e8" stroke-width="1" stroke-dasharray="4,3"/>
    <text x="925" y="278" class="unique-note" text-anchor="middle">UNIQUE(calendar_id, user_id)</text>
  </g>


  <!-- ======================================================= -->
  <!-- TABLE: sync_changes (x=790, y=345, w=270, 6 rows, h=184)-->
  <!-- ======================================================= -->
  <g filter="url(#shadow)">
    <rect x="790" y="345" width="270" height="184" rx="6" fill="#fff" stroke="#ddd" stroke-width="1"/>
    <rect x="790" y="345" width="270" height="32" rx="6" fill="url(#tableGrad2)"/>
    <rect x="790" y="365" width="270" height="12" fill="url(#tableGrad2)"/>
    <text x="925" y="367" class="table-header">sync_changes</text>
    <line x1="790" y1="377" x2="1060" y2="377" stroke="#e8e8e8" stroke-width="1"/>

    <rect x="791" y="377" width="268" height="24" fill="#f5faf6"/>
    <rect x="791" y="425" width="268" height="24" fill="#f5faf6"/>
    <rect x="791" y="473" width="268" height="24" fill="#f5faf6"/>

    <!-- Row 0: id -->
    <text x="800" y="395" class="pk-icon">PK</text>
    <text x="822" y="395" class="col">id</text>
    <text x="1050" y="395" class="col-type">INTEGER AUTO</text>

    <!-- Row 1: calendar_id -->
    <text x="800" y="419" class="fk-icon">FK</text>
    <text x="822" y="419" class="col">calendar_id</text>
    <text x="1050" y="419" class="col-type">TEXT</text>

    <!-- Row 2: object_uid -->
    <text x="822" y="443" class="col">object_uid</text>
    <text x="1050" y="443" class="col-type">TEXT</text>

    <!-- Row 3: change_type -->
    <text x="822" y="467" class="col">change_type</text>
    <text x="1050" y="467" class="col-type">TEXT</text>

    <!-- Row 4: sync_token -->
    <text x="822" y="491" class="col">sync_token</text>
    <text x="1050" y="491" class="col-type">TEXT</text>

    <!-- Row 5: created_at -->
    <text x="822" y="515" class="col">created_at</text>
    <text x="1050" y="515" class="col-type">TIMESTAMP</text>
  </g>


  <!-- ======================================================= -->
  <!-- RELATIONSHIPS                                            -->
  <!-- ======================================================= -->

  <!-- Rel 1: users.id 1--* calendars.owner_id                 -->
  <!-- users right edge: x=320, users.id row y = 95+32+0*24+12 = 139  -->
  <!-- calendars left edge: x=440, owner_id row y = 95+32+1*24+12 = 163 -->
  <path d="M 320,145 L 380,145 L 380,169 L 440,169"
        class="arrow" marker-start="url(#one)" marker-end="url(#many)"/>
  <text x="362" y="138" class="relation-label">owns</text>

  <!-- Rel 2: users.id 1--* mcp_tokens.user_id                 -->
  <!-- users bottom center: x=185, y=255                        -->
  <!-- mcp_tokens top center: x=185, y=325                      -->
  <path d="M 185,255 L 185,325"
        class="arrow" marker-start="url(#one)" marker-end="url(#many)"/>
  <text x="192" y="295" class="relation-label">has tokens</text>

  <!-- Rel 3: users.id 1--* calendar_shares.user_id             -->
  <!-- users right edge: x=320, y=145 (id row)                  -->
  <!-- calendar_shares left edge: x=790, user_id row y = 95+32+2*24+12 = 187 -->
  <!-- Route above the tables                                    -->
  <path d="M 320,157 L 350,157 L 350,88 L 775,88 L 775,193 L 790,193"
        class="arrow" marker-start="url(#one)" marker-end="url(#many)"/>
  <text x="535" y="84" class="relation-label">shares with</text>

  <!-- Rel 4: calendars.id 1--* calendar_objects.calendar_id    -->
  <!-- calendars bottom center: x=580, y=375                    -->
  <!-- calendar_objects top center: x=545, y=435                 -->
  <path d="M 560,375 L 560,435"
        class="arrow" marker-start="url(#one)" marker-end="url(#many)"/>
  <text x="567" y="410" class="relation-label">contains</text>

  <!-- Rel 5: calendars.id 1--* calendar_shares.calendar_id     -->
  <!-- calendars right edge: x=720, id row y = 139              -->
  <!-- calendar_shares left edge: x=790, calendar_id row y = 95+32+1*24+12 = 163 -->
  <path d="M 720,145 L 755,145 L 755,169 L 790,169"
        class="arrow" marker-start="url(#one)" marker-end="url(#many)"/>
  <text x="730" y="138" class="relation-label">shared via</text>

  <!-- Rel 6: calendars.id 1--* sync_changes.calendar_id        -->
  <!-- calendars right edge: x=720, id row y = 145              -->
  <!-- sync_changes left edge: x=790, calendar_id row y = 345+32+1*24+12 = 413 -->
  <path d="M 720,157 L 765,157 L 765,419 L 790,419"
        class="arrow" marker-start="url(#one)" marker-end="url(#many)"/>
  <text x="748" y="296" class="relation-label" text-anchor="middle" transform="rotate(-90, 748, 296)">tracks changes</text>


  <!-- ======================================================= -->
  <!-- LEGEND                                                   -->
  <!-- ======================================================= -->
  <g transform="translate(790, 585)">
    <rect x="0" y="0" width="260" height="198" rx="6" fill="#fff" stroke="#ddd" stroke-width="1" filter="url(#shadow)"/>
    <text x="130" y="22" class="legend-title" text-anchor="middle">Legend</text>
    <line x1="12" y1="32" x2="248" y2="32" stroke="#eee" stroke-width="1"/>

    <!-- PK -->
    <text x="18" y="52" class="pk-icon">PK</text>
    <text x="44" y="52" class="legend-text">Primary Key</text>

    <!-- FK -->
    <text x="18" y="74" class="fk-icon">FK</text>
    <text x="44" y="74" class="legend-text">Foreign Key</text>

    <!-- NN -->
    <text x="18" y="96" class="col-type" text-anchor="start">NN</text>
    <text x="44" y="96" class="legend-text">NOT NULL</text>

    <!-- 1:N relationship -->
    <line x1="18" y1="113" x2="72" y2="113" class="arrow" marker-start="url(#one)" marker-end="url(#many)"/>
    <text x="82" y="117" class="legend-text">One-to-Many</text>

    <!-- Color: Blue -->
    <rect x="18" y="131" width="16" height="12" rx="2" fill="url(#tableGrad)"/>
    <text x="44" y="141" class="legend-text">Core entities</text>

    <!-- Color: Green -->
    <rect x="18" y="151" width="16" height="12" rx="2" fill="url(#tableGrad2)"/>
    <text x="44" y="161" class="legend-text">Operational / tokens</text>

    <!-- Color: Purple -->
    <rect x="18" y="171" width="16" height="12" rx="2" fill="url(#tableGrad3)"/>
    <text x="44" y="181" class="legend-text">Association / join</text>
  </g>
</svg>
