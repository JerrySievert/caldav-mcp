<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 2650" width="800" height="2650">
  <defs>
    <style>
      .title { font: bold 20px sans-serif; fill: #333; }
      .subtitle { font: italic 13px sans-serif; fill: #666; }
      .phase-label { font: bold 16px sans-serif; fill: #555; }
      .node-text { font: bold 12px sans-serif; fill: #fff; text-anchor: middle; }
      .node-sub { font: 10px sans-serif; fill: rgba(255,255,255,0.85); text-anchor: middle; }
      .decision-text { font: bold 11px sans-serif; fill: #fff; text-anchor: middle; }
      .decision-sub { font: 9px sans-serif; fill: rgba(255,255,255,0.85); text-anchor: middle; }
      .label-text { font: bold 11px sans-serif; fill: #444; }
      .yes-label { font: bold 11px sans-serif; fill: #2d6a4f; }
      .no-label { font: bold 11px sans-serif; fill: #c1292e; }
      .arrow { stroke: #444; stroke-width: 1.8; marker-end: url(#arrowhead); }
      .arrow-yes { stroke: #2d6a4f; stroke-width: 1.8; marker-end: url(#arrowhead-yes); }
      .arrow-no { stroke: #c1292e; stroke-width: 1.8; marker-end: url(#arrowhead-no); }
      .note-title { font: bold 11px sans-serif; fill: #8b4513; }
      .note-text { font: 10px sans-serif; fill: #666; }
      .step-num { font: bold 10px sans-serif; fill: rgba(255,255,255,0.6); text-anchor: middle; }
    </style>

    <!-- Arrowhead markers -->
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#444"/>
    </marker>
    <marker id="arrowhead-yes" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2d6a4f"/>
    </marker>
    <marker id="arrowhead-no" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#c1292e"/>
    </marker>

    <!-- Drop shadow -->
    <filter id="shadow" x="-4%" y="-4%" width="108%" height="108%">
      <feDropShadow dx="1" dy="1" stdDeviation="2" flood-opacity="0.15"/>
    </filter>

    <!-- Node gradients -->
    <linearGradient id="startGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#5a9fd4"/>
      <stop offset="100%" stop-color="#4a90d9"/>
    </linearGradient>
    <linearGradient id="processGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#6b9def"/>
      <stop offset="100%" stop-color="#5b8def"/>
    </linearGradient>
    <linearGradient id="decisionGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#f0a14a"/>
      <stop offset="100%" stop-color="#e8913a"/>
    </linearGradient>
    <linearGradient id="endGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#2ebd6a"/>
      <stop offset="100%" stop-color="#27ae60"/>
    </linearGradient>
    <linearGradient id="errorGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#f05c4c"/>
      <stop offset="100%" stop-color="#e74c3c"/>
    </linearGradient>
  </defs>

  <!-- Background -->
  <rect width="800" height="2650" fill="#fafbfc" rx="8"/>

  <!-- Title -->
  <text x="400" y="32" class="title" text-anchor="middle">Apple Calendar (macOS 15.x) Discovery &amp; Sync Flow</text>
  <text x="400" y="50" class="subtitle" text-anchor="middle">accountsd (account setup) + dataaccessd (ongoing sync) -- two-daemon architecture</text>

  <!-- ============================================================ -->
  <!-- PHASE 1: accountsd  (Account Setup) -->
  <!-- ============================================================ -->
  <rect x="25" y="65" width="750" height="1290" rx="10" fill="none"
        stroke="#4a90d9" stroke-width="1.5" stroke-dasharray="8,4"/>
  <text x="40" y="85" class="phase-label">Phase 1: accountsd (Account Setup)</text>
  <text x="40" y="100" style="font: italic 11px sans-serif; fill: #888;">No auth sent during discovery probe</text>

  <!-- ============================================================ -->
  <!-- STEP 1: START - User adds CalDAV account  (ellipse, cy=135) -->
  <!-- top=109, bottom=161 -->
  <!-- ============================================================ -->
  <ellipse cx="330" cy="135" rx="130" ry="26" fill="url(#startGrad)" filter="url(#shadow)"/>
  <text x="330" y="133" class="node-text">User Adds CalDAV Account</text>
  <text x="330" y="147" class="node-sub">Apple Calendar Settings</text>

  <!-- Arrow: START -> Step 2 -->
  <line x1="330" y1="161" x2="330" y2="185" class="arrow"/>

  <!-- ============================================================ -->
  <!-- STEP 2: PROPFIND /.well-known/caldav  (rect y=185, h=48) -->
  <!-- ============================================================ -->
  <rect x="205" y="185" width="250" height="48" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="330" y="205" class="node-text">PROPFIND /.well-known/caldav</text>
  <text x="330" y="219" class="node-sub">accountsd -- no auth header</text>

  <!-- Arrow: Step 2 -> Step 3 -->
  <line x1="330" y1="233" x2="330" y2="257" class="arrow"/>

  <!-- ============================================================ -->
  <!-- STEP 3: Server returns 301  (rect y=257, h=48) -->
  <!-- ============================================================ -->
  <rect x="205" y="257" width="250" height="48" rx="6" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="330" y="277" class="node-text">Server Returns 301 Redirect</text>
  <text x="330" y="291" class="node-sub">Location: /caldav/</text>

  <!-- Arrow: Step 3 -> Step 4 -->
  <line x1="330" y1="305" x2="330" y2="329" class="arrow"/>

  <!-- ============================================================ -->
  <!-- STEP 4: PROPFIND /caldav/  (rect y=329, h=48) -->
  <!-- ============================================================ -->
  <rect x="205" y="329" width="250" height="48" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="330" y="349" class="node-text">PROPFIND /caldav/</text>
  <text x="330" y="363" class="node-sub">accountsd follows redirect</text>

  <!-- Arrow: Step 4 -> Step 5 -->
  <line x1="330" y1="377" x2="330" y2="401" class="arrow"/>

  <!-- ============================================================ -->
  <!-- STEP 5: Server returns 207 with principal  (rect y=401, h=48) -->
  <!-- ============================================================ -->
  <rect x="185" y="401" width="290" height="48" rx="6" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="330" y="421" class="node-text">Server Returns 207 Multi-Status</text>
  <text x="330" y="435" class="node-sub">current-user-principal (unauthenticated)</text>

  <!-- Arrow: Step 5 -> Step 6 -->
  <line x1="330" y1="449" x2="330" y2="473" class="arrow"/>

  <!-- ============================================================ -->
  <!-- STEP 6: PROPFIND /  (rect y=473, h=36) -->
  <!-- ============================================================ -->
  <rect x="220" y="473" width="220" height="36" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="330" y="495" class="node-text">PROPFIND / (server root)</text>

  <!-- Arrow: Step 6 -> Step 7 -->
  <line x1="330" y1="509" x2="330" y2="527" class="arrow"/>

  <!-- ============================================================ -->
  <!-- STEP 7: Server returns 207  (rect y=527, h=36) -->
  <!-- ============================================================ -->
  <rect x="220" y="527" width="220" height="36" rx="6" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="330" y="549" class="node-text">Server Returns 207</text>

  <!-- Arrow: Step 7 -> Step 8 -->
  <line x1="330" y1="563" x2="330" y2="581" class="arrow"/>

  <!-- ============================================================ -->
  <!-- STEP 8: PROPFIND /principals/  (rect y=581, h=36) -->
  <!-- ============================================================ -->
  <rect x="220" y="581" width="220" height="36" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="330" y="603" class="node-text">PROPFIND /principals/</text>

  <!-- Arrow: Step 8 -> Step 9 -->
  <line x1="330" y1="617" x2="330" y2="635" class="arrow"/>

  <!-- ============================================================ -->
  <!-- STEP 9: Server returns 207  (rect y=635, h=36) -->
  <!-- ============================================================ -->
  <rect x="220" y="635" width="220" height="36" rx="6" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="330" y="657" class="node-text">Server Returns 207</text>

  <!-- Arrow: Step 9 -> Step 10 -->
  <line x1="330" y1="671" x2="330" y2="695" class="arrow"/>

  <!-- ============================================================ -->
  <!-- STEP 10: PROPFIND /calendar/dav/{email}/user/  (rect y=695, h=48) -->
  <!-- ============================================================ -->
  <rect x="170" y="695" width="320" height="48" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="330" y="715" class="node-text">PROPFIND /calendar/dav/{email}/user/</text>
  <text x="330" y="729" class="node-sub">accountsd -- no auth header</text>

  <!-- Arrow: Step 10 -> Step 11 -->
  <line x1="330" y1="743" x2="330" y2="767" class="arrow"/>

  <!-- ============================================================ -->
  <!-- STEP 11: Server returns 207 generic  (rect y=767, h=58) -->
  <!-- ============================================================ -->
  <rect x="170" y="767" width="320" height="58" rx="6" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="330" y="787" class="node-text">Server Returns 207</text>
  <text x="330" y="801" class="node-sub">Generic "CalDAV Account" displayname</text>
  <text x="330" y="814" class="node-sub">No username leaked -- prevents enumeration</text>

  <!-- Arrow: Step 11 -> Step 12 -->
  <line x1="330" y1="825" x2="330" y2="849" class="arrow"/>

  <!-- ============================================================ -->
  <!-- STEP 12: accountsd prompts for password  (rect y=849, h=48) -->
  <!-- ============================================================ -->
  <rect x="195" y="849" width="270" height="48" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="330" y="869" class="node-text">accountsd Prompts User</text>
  <text x="330" y="883" class="node-sub">macOS password dialog shown</text>

  <!-- Arrow: Step 12 -> Step 13 -->
  <line x1="330" y1="897" x2="330" y2="921" class="arrow"/>

  <!-- ============================================================ -->
  <!-- STEP 13: PROPFIND with Basic Auth  (rect y=921, h=48) -->
  <!-- ============================================================ -->
  <rect x="160" y="921" width="340" height="48" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="330" y="941" class="node-text">PROPFIND /calendar/dav/{email}/user/</text>
  <text x="330" y="955" class="node-sub">WITH Basic Auth (first time credentials sent)</text>

  <!-- Arrow: Step 13 -> Decision -->
  <line x1="330" y1="969" x2="330" y2="1010" class="arrow"/>

  <!-- ============================================================ -->
  <!-- DECISION: Credentials valid?  (cy=1050, dy=40, dx=100) -->
  <!-- top=1010, bottom=1090, left=230, right=430 -->
  <!-- ============================================================ -->
  <polygon points="330,1010 430,1050 330,1090 230,1050" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="330" y="1047" class="decision-text">Credentials</text>
  <text x="330" y="1059" class="decision-text">valid?</text>

  <!-- No arrow: right vertex (430,1050) -> error box -->
  <line x1="430" y1="1050" x2="557" y2="1050" class="arrow-no"/>
  <text x="445" y="1043" class="no-label">No</text>

  <!-- Error: Show error to user -->
  <rect x="560" y="1032" width="200" height="36" rx="6" fill="url(#errorGrad)" filter="url(#shadow)"/>
  <text x="660" y="1047" class="node-text">Show Error to User</text>
  <text x="660" y="1060" class="node-sub">Invalid credentials -- 401</text>

  <!-- Error -> END (error) -->
  <line x1="660" y1="1068" x2="660" y2="1100" class="arrow-no"/>
  <ellipse cx="660" cy="1122" rx="40" ry="22" fill="url(#errorGrad)" filter="url(#shadow)"/>
  <text x="660" y="1127" class="node-text">END</text>

  <!-- Yes arrow: bottom vertex (330,1090) -> Step 14 -->
  <line x1="330" y1="1090" x2="330" y2="1128" class="arrow-yes"/>
  <text x="340" y="1107" class="yes-label">Yes</text>

  <!-- ============================================================ -->
  <!-- STEP 14: Server returns 207 with real data  (rect y=1128, h=58) -->
  <!-- ============================================================ -->
  <rect x="160" y="1128" width="340" height="58" rx="6" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="330" y="1148" class="node-text">Server Returns 207 (Authenticated)</text>
  <text x="330" y="1162" class="node-sub">Real username + calendar-home-set</text>
  <text x="330" y="1175" class="node-sub">/caldav/users/{username}/</text>

  <!-- Arrow: Step 14 -> Step 15 -->
  <line x1="330" y1="1186" x2="330" y2="1215" class="arrow-yes"/>

  <!-- ============================================================ -->
  <!-- STEP 15: Account setup complete  (rect y=1215, h=48) -->
  <!-- ============================================================ -->
  <rect x="195" y="1215" width="270" height="48" rx="6" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="330" y="1235" class="node-text">Account Setup Complete</text>
  <text x="330" y="1249" class="node-sub">accountsd hands off to dataaccessd</text>

  <!-- Annotation box: Phase 1 security note -->
  <rect x="575" y="140" width="190" height="100" rx="6" fill="#fffef5"
        stroke="#e8c96a" stroke-width="1.2"/>
  <text x="590" y="158" class="note-title">Security Note</text>
  <text x="590" y="174" class="note-text">accountsd never sends</text>
  <text x="590" y="187" class="note-text">auth during the initial</text>
  <text x="590" y="200" class="note-text">discovery probe (steps 2-11).</text>
  <text x="590" y="216" class="note-text">All responses must work</text>
  <text x="590" y="229" class="note-text">without credentials.</text>

  <!-- Annotation box: Email enumeration note -->
  <rect x="575" y="770" width="190" height="75" rx="6" fill="#fffef5"
        stroke="#e8c96a" stroke-width="1.2"/>
  <text x="590" y="788" class="note-title">Anti-Enumeration</text>
  <text x="590" y="804" class="note-text">Identical 207 response for</text>
  <text x="590" y="817" class="note-text">valid and invalid emails.</text>
  <text x="590" y="830" class="note-text">No data distinguishes them.</text>

  <!-- ============================================================ -->
  <!-- PHASE DIVIDER -->
  <!-- ============================================================ -->
  <line x1="40" y1="1380" x2="760" y2="1380" stroke="#999" stroke-width="1.5" stroke-dasharray="12,6"/>
  <rect x="280" y="1367" width="240" height="26" rx="4" fill="#fafbfc"/>
  <text x="400" y="1385" style="font: bold 12px sans-serif; fill: #888; text-anchor: middle;">Daemon Handoff</text>

  <!-- ============================================================ -->
  <!-- PHASE 2: dataaccessd  (Ongoing Sync) -->
  <!-- ============================================================ -->
  <rect x="25" y="1410" width="750" height="1010" rx="10" fill="none"
        stroke="#27ae60" stroke-width="1.5" stroke-dasharray="8,4"/>
  <text x="40" y="1430" class="phase-label">Phase 2: dataaccessd (Ongoing Sync)</text>
  <text x="40" y="1445" style="font: italic 11px sans-serif; fill: #888;">Auth ONLY sent to email discovery URL -- never to /caldav/users/*</text>

  <!-- ============================================================ -->
  <!-- STEP 16: PROPFIND /calendar/dav/{email}/user/ Depth:1 WITH auth -->
  <!-- rect y=1470, h=58 -->
  <!-- ============================================================ -->
  <rect x="145" y="1470" width="370" height="58" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="330" y="1490" class="node-text">PROPFIND /calendar/dav/{email}/user/</text>
  <text x="330" y="1504" class="node-sub">Depth:1 -- WITH Basic Auth</text>
  <text x="330" y="1517" class="node-sub">dataaccessd sends credentials here</text>

  <!-- Arrow: Step 16 -> Step 17 -->
  <line x1="330" y1="1528" x2="330" y2="1556" class="arrow"/>

  <!-- ============================================================ -->
  <!-- STEP 17: Server returns 207 with calendar list  (rect y=1556, h=48) -->
  <!-- ============================================================ -->
  <rect x="170" y="1556" width="320" height="48" rx="6" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="330" y="1576" class="node-text">Server Returns 207 (Calendar List)</text>
  <text x="330" y="1590" class="node-sub">Authenticated -- includes calendar collection hrefs</text>

  <!-- Arrow: Step 17 -> Step 18 -->
  <line x1="330" y1="1604" x2="330" y2="1632" class="arrow"/>

  <!-- ============================================================ -->
  <!-- STEP 18: PROPFIND /caldav/users/{username}/  (rect y=1632, h=58) -->
  <!-- ============================================================ -->
  <rect x="155" y="1632" width="350" height="58" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="330" y="1652" class="node-text">PROPFIND /caldav/users/{username}/</text>
  <text x="330" y="1666" class="node-sub">NO auth header sent!</text>
  <text x="330" y="1679" class="node-sub">dataaccessd does not send creds to this URL</text>

  <!-- Arrow: Step 18 -> Step 19 -->
  <line x1="330" y1="1690" x2="330" y2="1718" class="arrow"/>

  <!-- ============================================================ -->
  <!-- STEP 19: Server uses path-based fallback  (rect y=1718, h=58) -->
  <!-- ============================================================ -->
  <rect x="155" y="1718" width="350" height="58" rx="6" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="330" y="1738" class="node-text">Server: Path-Based User Fallback</text>
  <text x="330" y="1752" class="node-sub">Resolves user from {username} in URL path</text>
  <text x="330" y="1765" class="node-sub">Returns 207 with calendar-home-set</text>

  <!-- Arrow: Step 19 -> Step 20 -->
  <line x1="330" y1="1776" x2="330" y2="1804" class="arrow"/>

  <!-- ============================================================ -->
  <!-- STEP 20: PROPFIND /caldav/users/{username}/{cal}/  (rect y=1804, h=58) -->
  <!-- ============================================================ -->
  <rect x="130" y="1804" width="400" height="58" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="330" y="1824" class="node-text">PROPFIND /caldav/users/{username}/{cal}/</text>
  <text x="330" y="1838" class="node-sub">NO auth header sent!</text>
  <text x="330" y="1851" class="node-sub">Calendar collection details request</text>

  <!-- Arrow: Step 20 -> Step 21 -->
  <line x1="330" y1="1862" x2="330" y2="1890" class="arrow"/>

  <!-- ============================================================ -->
  <!-- STEP 21: Server returns calendar details  (rect y=1890, h=48) -->
  <!-- ============================================================ -->
  <rect x="155" y="1890" width="350" height="48" rx="6" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="330" y="1910" class="node-text">Server Returns Calendar Details</text>
  <text x="330" y="1924" class="node-sub">Via path-based fallback -- displayname, color, ctag</text>

  <!-- Arrow: Step 21 -> Step 22 -->
  <line x1="330" y1="1938" x2="330" y2="1966" class="arrow"/>

  <!-- ============================================================ -->
  <!-- STEP 22: REPORT sync-collection  (rect y=1966, h=48) -->
  <!-- ============================================================ -->
  <rect x="155" y="1966" width="350" height="48" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="330" y="1986" class="node-text">REPORT on Calendars</text>
  <text x="330" y="2000" class="node-sub">sync-collection (RFC 6578 delta sync)</text>

  <!-- Arrow: Step 22 -> Step 23 -->
  <line x1="330" y1="2014" x2="330" y2="2042" class="arrow"/>

  <!-- ============================================================ -->
  <!-- STEP 23: Ongoing sync  (rect y=2042, h=48) -->
  <!-- ============================================================ -->
  <rect x="195" y="2042" width="270" height="48" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="330" y="2062" class="node-text">Ongoing Sync Continues</text>
  <text x="330" y="2076" class="node-sub">Periodic REPORT + PROPFIND cycles</text>

  <!-- Arrow: Step 23 -> END -->
  <line x1="330" y1="2090" x2="330" y2="2120" class="arrow"/>

  <!-- ============================================================ -->
  <!-- STEP 24: END  (ellipse cy=2145) -->
  <!-- ============================================================ -->
  <ellipse cx="330" cy="2145" rx="60" ry="26" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="330" y="2150" class="node-text">END</text>

  <!-- Annotation box: dataaccessd auth quirk -->
  <rect x="575" y="1470" width="190" height="100" rx="6" fill="#fffef5"
        stroke="#e8c96a" stroke-width="1.2"/>
  <text x="590" y="1488" class="note-title">Auth Quirk</text>
  <text x="590" y="1504" class="note-text">dataaccessd ONLY sends</text>
  <text x="590" y="1517" class="note-text">Basic Auth credentials to</text>
  <text x="590" y="1530" class="note-text">/calendar/dav/{email}/user/</text>
  <text x="590" y="1546" class="note-text">All other URLs receive</text>
  <text x="590" y="1559" class="note-text">NO auth header at all.</text>

  <!-- Annotation box: path fallback note -->
  <rect x="575" y="1718" width="190" height="88" rx="6" fill="#fffef5"
        stroke="#e8c96a" stroke-width="1.2"/>
  <text x="590" y="1736" class="note-title">Path Fallback Required</text>
  <text x="590" y="1752" class="note-text">For /caldav/users/* URLs,</text>
  <text x="590" y="1765" class="note-text">server must resolve user</text>
  <text x="590" y="1778" class="note-text">from {username} path param</text>
  <text x="590" y="1791" class="note-text">when no auth is present.</text>

  <!-- Annotation box: Set-Cookie note -->
  <rect x="575" y="1960" width="190" height="75" rx="6" fill="#fffef5"
        stroke="#e8c96a" stroke-width="1.2"/>
  <text x="590" y="1978" class="note-title">No Cookie Support</text>
  <text x="590" y="1994" class="note-text">dataaccessd does NOT</text>
  <text x="590" y="2007" class="note-text">honor Set-Cookie headers.</text>
  <text x="590" y="2020" class="note-text">Session auth is not viable.</text>

  <!-- ============================================================ -->
  <!-- LEGEND -->
  <!-- ============================================================ -->
  <g transform="translate(30, 2240)">
    <text x="0" y="0" class="label-text" style="font-size:13px">Legend</text>

    <!-- Start terminal -->
    <ellipse cx="25" cy="25" rx="20" ry="12" fill="url(#startGrad)"/>
    <text x="55" y="30" class="label-text">Start</text>

    <!-- Process -->
    <rect x="5" y="45" width="40" height="18" rx="4" fill="url(#processGrad)"/>
    <text x="55" y="59" class="label-text">Client request (PROPFIND / REPORT)</text>

    <!-- Decision -->
    <polygon points="25,75 40,87 25,99 10,87" fill="url(#decisionGrad)"/>
    <text x="55" y="92" class="label-text">Decision</text>

    <!-- Success -->
    <rect x="5" y="110" width="40" height="18" rx="4" fill="url(#endGrad)"/>
    <text x="55" y="124" class="label-text">Server response (207 / success)</text>

    <!-- Error -->
    <rect x="5" y="140" width="40" height="18" rx="4" fill="url(#errorGrad)"/>
    <text x="55" y="154" class="label-text">Error response (401 / failure)</text>

    <!-- Annotation -->
    <rect x="5" y="170" width="40" height="18" rx="4" fill="#fffef5" stroke="#e8c96a" stroke-width="1"/>
    <text x="55" y="184" class="label-text">Security annotation</text>

    <!-- Arrow legend -->
    <line x1="400" y1="25" x2="450" y2="25" class="arrow"/>
    <text x="460" y="30" class="label-text">Main flow</text>

    <line x1="400" y1="55" x2="450" y2="55" class="arrow-yes"/>
    <text x="460" y="60" class="yes-label">Yes / success path</text>

    <line x1="400" y1="85" x2="450" y2="85" class="arrow-no"/>
    <text x="460" y="90" class="no-label">No / error path</text>

    <!-- Phase borders -->
    <line x1="400" y1="115" x2="450" y2="115" stroke="#4a90d9" stroke-width="1.5" stroke-dasharray="8,4"/>
    <text x="460" y="120" class="label-text">accountsd phase</text>

    <line x1="400" y1="145" x2="450" y2="145" stroke="#27ae60" stroke-width="1.5" stroke-dasharray="8,4"/>
    <text x="460" y="150" class="label-text">dataaccessd phase</text>
  </g>

  <!-- ============================================================ -->
  <!-- KEY SECURITY SUMMARY (bottom panel) -->
  <!-- ============================================================ -->
  <rect x="30" y="2480" width="740" height="140" rx="8" fill="#fffef5"
        stroke="#e8c96a" stroke-width="1.5"/>
  <text x="400" y="2502" style="font: bold 14px sans-serif; fill: #8b4513; text-anchor: middle;">Key Security Summary</text>

  <text x="50" y="2524" class="note-text" style="font-size:11px">1. accountsd never sends auth initially -- all discovery responses must work without credentials</text>
  <text x="50" y="2542" class="note-text" style="font-size:11px">2. dataaccessd ONLY sends Basic Auth to /calendar/dav/{email}/user/ (the email discovery URL)</text>
  <text x="50" y="2560" class="note-text" style="font-size:11px">3. dataaccessd does NOT honor Set-Cookie headers -- session-based auth is not viable</text>
  <text x="50" y="2578" class="note-text" style="font-size:11px">4. Path-based user fallback is REQUIRED for all /caldav/users/* URLs (no auth available)</text>
  <text x="50" y="2596" class="note-text" style="font-size:11px">5. Email enumeration prevented: identical 207 response for valid and invalid email addresses</text>
  <text x="50" y="2614" class="note-text" style="font-size:11px">6. Username not leaked in unauthenticated responses (generic "CalDAV Account" displayname)</text>
</svg>
