<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 1100" width="800" height="1100">
  <defs>
    <style>
      .title { font: bold 20px sans-serif; fill: #333; }
      .node-text { font: bold 12px sans-serif; fill: #fff; text-anchor: middle; }
      .node-sub { font: 10px sans-serif; fill: rgba(255,255,255,0.85); text-anchor: middle; }
      .decision-text { font: bold 11px sans-serif; fill: #fff; text-anchor: middle; }
      .decision-sub { font: 9px sans-serif; fill: rgba(255,255,255,0.85); text-anchor: middle; }
      .label-text { font: bold 11px sans-serif; fill: #444; }
      .yes-label { font: bold 11px sans-serif; fill: #2d6a4f; }
      .no-label { font: bold 11px sans-serif; fill: #c1292e; }
      .arrow { stroke: #444; stroke-width: 1.8; marker-end: url(#arrowhead); }
      .arrow-yes { stroke: #2d6a4f; stroke-width: 1.8; marker-end: url(#arrowhead-yes); }
      .arrow-no { stroke: #c1292e; stroke-width: 1.8; marker-end: url(#arrowhead-no); }
    </style>

    <!-- Arrowhead markers -->
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#444"/>
    </marker>
    <marker id="arrowhead-yes" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2d6a4f"/>
    </marker>
    <marker id="arrowhead-no" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#c1292e"/>
    </marker>

    <!-- Drop shadow -->
    <filter id="shadow" x="-4%" y="-4%" width="108%" height="108%">
      <feDropShadow dx="1" dy="1" stdDeviation="2" flood-opacity="0.15"/>
    </filter>

    <!-- Node gradients -->
    <linearGradient id="startGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#5a9fd4"/>
      <stop offset="100%" stop-color="#4a90d9"/>
    </linearGradient>
    <linearGradient id="processGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#6b9def"/>
      <stop offset="100%" stop-color="#5b8def"/>
    </linearGradient>
    <linearGradient id="decisionGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#f0a14a"/>
      <stop offset="100%" stop-color="#e8913a"/>
    </linearGradient>
    <linearGradient id="endGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#2ebd6a"/>
      <stop offset="100%" stop-color="#27ae60"/>
    </linearGradient>
    <linearGradient id="errorGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#f05c4c"/>
      <stop offset="100%" stop-color="#e74c3c"/>
    </linearGradient>
  </defs>

  <!-- Background -->
  <rect width="800" height="1100" fill="#fafbfc" rx="8"/>

  <!-- Title -->
  <text x="400" y="35" class="title" text-anchor="middle">Well-Known &amp; Discovery Flow</text>

  <!-- ============================================================ -->
  <!-- START: Client Request  (ellipse, cy=75) -->
  <!-- ============================================================ -->
  <ellipse cx="330" cy="75" rx="100" ry="26" fill="url(#startGrad)" filter="url(#shadow)"/>
  <text x="330" y="80" class="node-text">Client Request</text>

  <!-- Arrow: START bottom -> Decision 1 top -->
  <line x1="330" y1="101" x2="330" y2="145" class="arrow"/>

  <!-- ============================================================ -->
  <!-- DECISION 1: Is method OPTIONS?  (cy=185, dy=40, dx=100) -->
  <!-- top=145, bottom=225, left=230, right=430 -->
  <!-- ============================================================ -->
  <polygon points="330,145 430,185 330,225 230,185" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="330" y="182" class="decision-text">Is method</text>
  <text x="330" y="194" class="decision-text">OPTIONS?</text>

  <!-- Yes arrow: right vertex (430,185) -> result box -->
  <line x1="430" y1="185" x2="557" y2="185" class="arrow-yes"/>
  <text x="445" y="178" class="yes-label">Yes</text>

  <!-- Result: Return 200 DAV headers -->
  <rect x="560" y="167" width="210" height="36" rx="6" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="665" y="182" class="node-text">Return 200 OK</text>
  <text x="665" y="195" class="node-sub">DAV: 1,2,3,calendar-access</text>

  <!-- No arrow: bottom vertex (330,225) -> Decision 2 top -->
  <line x1="330" y1="225" x2="330" y2="275" class="arrow"/>
  <text x="340" y="242" class="no-label">No</text>

  <!-- ============================================================ -->
  <!-- DECISION 2: Is path /.well-known/caldav?  (cy=315, dy=40, dx=110) -->
  <!-- top=275, bottom=355, left=220, right=440 -->
  <!-- ============================================================ -->
  <polygon points="330,275 440,315 330,355 220,315" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="330" y="312" class="decision-text">Is path</text>
  <text x="330" y="324" class="decision-sub">/.well-known/caldav?</text>

  <!-- Yes arrow: right vertex (440,315) -> result box -->
  <line x1="440" y1="315" x2="557" y2="315" class="arrow-yes"/>
  <text x="455" y="308" class="yes-label">Yes</text>

  <!-- Result: Return 301 redirect -->
  <rect x="560" y="297" width="210" height="36" rx="6" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="665" y="312" class="node-text">Return 301 Redirect</text>
  <text x="665" y="325" class="node-sub">Location: /caldav/</text>

  <!-- No arrow: bottom vertex (330,355) -> Decision 3 top -->
  <line x1="330" y1="355" x2="330" y2="405" class="arrow"/>
  <text x="340" y="372" class="no-label">No</text>

  <!-- ============================================================ -->
  <!-- DECISION 3: Is method PROPFIND?  (cy=445, dy=40, dx=100) -->
  <!-- top=405, bottom=485, left=230, right=430 -->
  <!-- ============================================================ -->
  <polygon points="330,405 430,445 330,485 230,445" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="330" y="442" class="decision-text">Is method</text>
  <text x="330" y="454" class="decision-text">PROPFIND?</text>

  <!-- No arrow: right vertex (430,445) -> result box -->
  <line x1="430" y1="445" x2="557" y2="445" class="arrow-no"/>
  <text x="445" y="438" class="no-label">No</text>

  <!-- Result: Return 405 -->
  <rect x="560" y="427" width="210" height="36" rx="6" fill="url(#errorGrad)" filter="url(#shadow)"/>
  <text x="665" y="442" class="node-text">Return 405</text>
  <text x="665" y="455" class="node-sub">Method Not Allowed</text>

  <!-- Yes arrow: bottom vertex (330,485) -> Decision 4 top -->
  <line x1="330" y1="485" x2="330" y2="535" class="arrow"/>
  <text x="340" y="502" class="yes-label">Yes</text>

  <!-- ============================================================ -->
  <!-- DECISION 4: Is path a discovery path?  (cy=575, dy=40, dx=110) -->
  <!-- top=535, bottom=615, left=220, right=440 -->
  <!-- ============================================================ -->
  <polygon points="330,535 440,575 330,615 220,575" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="330" y="570" class="decision-text">Is discovery</text>
  <text x="330" y="582" class="decision-sub">/caldav/ /principals/ etc.?</text>

  <!-- No arrow: right vertex (440,575) -> result box -->
  <line x1="440" y1="575" x2="557" y2="575" class="arrow-no"/>
  <text x="455" y="568" class="no-label">No</text>

  <!-- Result: Route to other handlers -->
  <rect x="560" y="557" width="210" height="36" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="665" y="572" class="node-text">Route to Other</text>
  <text x="665" y="585" class="node-sub">Calendar/collection handlers</text>

  <!-- Yes arrow: bottom vertex (330,615) -> Decision 5 top -->
  <line x1="330" y1="615" x2="330" y2="665" class="arrow"/>
  <text x="340" y="632" class="yes-label">Yes</text>

  <!-- ============================================================ -->
  <!-- DECISION 5: Has Authorization header?  (cy=705, dy=40, dx=110) -->
  <!-- top=665, bottom=745, left=220, right=440 -->
  <!-- ============================================================ -->
  <polygon points="330,665 440,705 330,745 220,705" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="330" y="702" class="decision-text">Has Authorization</text>
  <text x="330" y="714" class="decision-text">header?</text>

  <!-- No arrow: right vertex (440,705) -> result box -->
  <line x1="440" y1="705" x2="557" y2="705" class="arrow-no"/>
  <text x="455" y="698" class="no-label">No</text>

  <!-- Result: Return 207 unauthenticated -->
  <rect x="560" y="687" width="210" height="48" rx="6" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="665" y="706" class="node-text">Return 207 Multi-Status</text>
  <text x="665" y="720" class="node-sub">&lt;D:unauthenticated/&gt; principal</text>
  <text x="665" y="731" class="node-sub">No user data leaked</text>

  <!-- Yes arrow: bottom vertex (330,745) -> Decision 6 top -->
  <line x1="330" y1="745" x2="330" y2="795" class="arrow"/>
  <text x="340" y="762" class="yes-label">Yes</text>

  <!-- ============================================================ -->
  <!-- DECISION 6: Valid credentials?  (cy=835, dy=40, dx=100) -->
  <!-- top=795, bottom=875, left=230, right=430 -->
  <!-- ============================================================ -->
  <polygon points="330,795 430,835 330,875 230,835" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="330" y="832" class="decision-text">Valid</text>
  <text x="330" y="844" class="decision-text">credentials?</text>

  <!-- No arrow: right vertex (430,835) -> result box -->
  <line x1="430" y1="835" x2="557" y2="835" class="arrow-no"/>
  <text x="445" y="828" class="no-label">No</text>

  <!-- Result: Return 401 -->
  <rect x="560" y="817" width="210" height="36" rx="6" fill="url(#errorGrad)" filter="url(#shadow)"/>
  <text x="665" y="832" class="node-text">Return 401</text>
  <text x="665" y="845" class="node-sub">Unauthorized</text>

  <!-- Yes arrow: left vertex (230,835) -> result box -->
  <line x1="230" y1="835" x2="193" y2="835" class="arrow-yes"/>
  <text x="215" y="828" class="yes-label">Yes</text>

  <!-- Result: Return 207 with principal -->
  <rect x="15" y="811" width="175" height="48" rx="6" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="102" y="830" class="node-text">Return 207</text>
  <text x="102" y="844" class="node-sub">current-user-principal =</text>
  <text x="102" y="855" class="node-sub">/caldav/principals/{user}/</text>

  <!-- ============================================================ -->
  <!-- LEGEND -->
  <!-- ============================================================ -->
  <g transform="translate(30, 930)">
    <text x="0" y="0" class="label-text" style="font-size:13px">Legend</text>

    <!-- Start/End terminal -->
    <ellipse cx="25" cy="25" rx="20" ry="12" fill="url(#startGrad)"/>
    <text x="55" y="30" class="label-text">Start</text>

    <!-- Decision -->
    <polygon points="25,50 40,62 25,74 10,62" fill="url(#decisionGrad)"/>
    <text x="55" y="67" class="label-text">Decision</text>

    <!-- Success result -->
    <rect x="5" y="85" width="40" height="18" rx="4" fill="url(#endGrad)"/>
    <text x="55" y="99" class="label-text">Success response</text>

    <!-- Error result -->
    <rect x="5" y="115" width="40" height="18" rx="4" fill="url(#errorGrad)"/>
    <text x="55" y="129" class="label-text">Error response</text>

    <!-- Process -->
    <rect x="5" y="145" width="40" height="18" rx="4" fill="url(#processGrad)"/>
    <text x="55" y="159" class="label-text">Route to handler</text>

    <!-- Arrow legend -->
    <line x1="250" y1="25" x2="300" y2="25" class="arrow-yes"/>
    <text x="310" y="30" class="yes-label">Yes / true path</text>

    <line x1="250" y1="55" x2="300" y2="55" class="arrow-no"/>
    <text x="310" y="60" class="no-label">No / false path</text>

    <line x1="250" y1="85" x2="300" y2="85" class="arrow"/>
    <text x="310" y="90" class="label-text">Main flow / continue</text>
  </g>
</svg>
