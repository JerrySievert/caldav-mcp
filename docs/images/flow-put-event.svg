<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 700 1370" width="700" height="1370">
  <defs>
    <style>
      .title { font: bold 20px sans-serif; fill: #333; }
      .node-text { font: bold 12px sans-serif; fill: #fff; text-anchor: middle; }
      .node-sub { font: 10px sans-serif; fill: rgba(255,255,255,0.85); text-anchor: middle; }
      .decision-text { font: bold 11px sans-serif; fill: #fff; text-anchor: middle; }
      .label-text { font: bold 11px sans-serif; fill: #444; }
      .yes-label { font: bold 11px sans-serif; fill: #2d6a4f; }
      .no-label { font: bold 11px sans-serif; fill: #c1292e; }
      .arrow { stroke: #444; stroke-width: 1.8; marker-end: url(#arrowhead); }
      .arrow-yes { stroke: #2d6a4f; stroke-width: 1.8; marker-end: url(#arrowhead-yes); }
      .arrow-no { stroke: #c1292e; stroke-width: 1.8; marker-end: url(#arrowhead-no); }
    </style>

    <!-- Arrowhead markers -->
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#444"/>
    </marker>
    <marker id="arrowhead-yes" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#2d6a4f"/>
    </marker>
    <marker id="arrowhead-no" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#c1292e"/>
    </marker>

    <!-- Drop shadow -->
    <filter id="shadow" x="-4%" y="-4%" width="108%" height="108%">
      <feDropShadow dx="1" dy="1" stdDeviation="2" flood-opacity="0.15"/>
    </filter>

    <!-- Node gradients -->
    <linearGradient id="startGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#5a9fd4"/>
      <stop offset="100%" stop-color="#4a90d9"/>
    </linearGradient>
    <linearGradient id="processGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#6b9def"/>
      <stop offset="100%" stop-color="#5b8def"/>
    </linearGradient>
    <linearGradient id="decisionGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#f0a14a"/>
      <stop offset="100%" stop-color="#e8913a"/>
    </linearGradient>
    <linearGradient id="endGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#2ebd6a"/>
      <stop offset="100%" stop-color="#27ae60"/>
    </linearGradient>
    <linearGradient id="errorGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#f05c4c"/>
      <stop offset="100%" stop-color="#e74c3c"/>
    </linearGradient>
  </defs>

  <!-- Background -->
  <rect width="700" height="1370" fill="#fafbfc" rx="8"/>

  <!-- Title -->
  <text x="350" y="35" class="title" text-anchor="middle">PUT Event (Create/Update) Flow</text>

  <!-- ============================================================ -->
  <!-- 1. START: PUT Request -->
  <!-- Ellipse: cx=350, cy=70, rx=160, ry=26 -->
  <!-- ============================================================ -->
  <ellipse cx="350" cy="70" rx="160" ry="26" fill="url(#startGrad)" filter="url(#shadow)"/>
  <text x="350" y="67" class="node-text">PUT Request</text>
  <text x="350" y="80" class="node-sub">/{username}/{calendar_id}/{uid}.ics</text>

  <!-- Arrow: START -> Decision: OPTIONS? -->
  <!-- START bottom: y=96, Diamond top: y=135-40=95... let me recalc -->
  <!-- Diamond center at y=140, DY=35, so top vertex = 105 -->
  <line x1="350" y1="96" x2="350" y2="105" class="arrow"/>

  <!-- ============================================================ -->
  <!-- 2. Decision: Is method OPTIONS? -->
  <!-- Diamond: cx=350, cy=140, DX=90, DY=35 -->
  <!-- Vertices: top=(350,105), right=(440,140), bottom=(350,175), left=(260,140) -->
  <!-- ============================================================ -->
  <polygon points="350,105 440,140 350,175 260,140" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="350" y="137" class="decision-text">Is method</text>
  <text x="350" y="149" class="decision-text">OPTIONS?</text>

  <!-- Yes branch: right -> Return 200 with DAV headers (endGrad) -->
  <!-- Ellipse at cx=590, cy=140, rx=80, ry=22 -->
  <line x1="440" y1="140" x2="510" y2="140" class="arrow-yes"/>
  <text x="470" y="133" class="yes-label">Yes</text>

  <ellipse cx="590" cy="140" rx="80" ry="22" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="590" y="137" class="node-text">200 OK</text>
  <text x="590" y="149" class="node-sub">DAV headers</text>

  <!-- No branch: bottom -> auth process -->
  <text x="360" y="190" class="no-label">No</text>

  <!-- Arrow: OPTIONS decision bottom -> auth_or_path_user rect -->
  <!-- Diamond bottom: y=175, rect top: y=205 -->
  <line x1="350" y1="175" x2="350" y2="205" class="arrow"/>

  <!-- ============================================================ -->
  <!-- 3. Process: auth_or_path_user -->
  <!-- Rect: x=210, y=205, w=280, h=48 -->
  <!-- ============================================================ -->
  <rect x="210" y="205" width="280" height="48" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="350" y="225" class="node-text">Call auth_or_path_user</text>
  <text x="350" y="239" class="node-sub">HTTP Basic Auth header / {username} path fallback</text>

  <!-- Arrow: auth process -> User resolved? decision -->
  <!-- Rect bottom: y=253, Diamond top: y=290-35=255... wait -->
  <!-- Diamond center at y=300, DY=35, top=265 -->
  <line x1="350" y1="253" x2="350" y2="265" class="arrow"/>

  <!-- ============================================================ -->
  <!-- 4. Decision: User resolved? -->
  <!-- Diamond: cx=350, cy=300, DX=90, DY=35 -->
  <!-- Vertices: top=(350,265), right=(440,300), bottom=(350,335), left=(260,300) -->
  <!-- ============================================================ -->
  <polygon points="350,265 440,300 350,335 260,300" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="350" y="304" class="decision-text">User resolved?</text>

  <!-- No branch: right -> 401 Unauthorized (errorGrad) -->
  <line x1="440" y1="300" x2="510" y2="300" class="arrow-no"/>
  <text x="470" y="293" class="no-label">No</text>

  <ellipse cx="590" cy="300" rx="80" ry="22" fill="url(#errorGrad)" filter="url(#shadow)"/>
  <text x="590" y="297" class="node-text">401</text>
  <text x="590" y="309" class="node-sub">Unauthorized</text>

  <!-- Yes branch: bottom -> Look up calendar -->
  <text x="360" y="350" class="yes-label">Yes</text>
  <line x1="350" y1="335" x2="350" y2="365" class="arrow-yes"/>

  <!-- ============================================================ -->
  <!-- 5. Process: Look up calendar -->
  <!-- Rect: x=220, y=365, w=260, h=48 -->
  <!-- ============================================================ -->
  <rect x="220" y="365" width="260" height="48" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="350" y="385" class="node-text">Look up calendar</text>
  <text x="350" y="399" class="node-sub">by {calendar_id} for user</text>

  <!-- Arrow: calendar lookup -> Calendar exists? decision -->
  <!-- Rect bottom: y=413, Diamond top: y=445-35=410... -->
  <!-- Diamond center at y=460, DY=35, top=425 -->
  <line x1="350" y1="413" x2="350" y2="425" class="arrow"/>

  <!-- ============================================================ -->
  <!-- 6. Decision: Calendar exists & belongs to user? -->
  <!-- Diamond: cx=350, cy=460, DX=110, DY=35 -->
  <!-- Vertices: top=(350,425), right=(460,460), bottom=(350,495), left=(240,460) -->
  <!-- ============================================================ -->
  <polygon points="350,425 460,460 350,495 240,460" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="350" y="457" class="decision-text">Calendar exists &amp;</text>
  <text x="350" y="469" class="decision-text">belongs to user?</text>

  <!-- No branch: right -> 403 Forbidden (errorGrad) -->
  <line x1="460" y1="460" x2="510" y2="460" class="arrow-no"/>
  <text x="480" y="453" class="no-label">No</text>

  <ellipse cx="590" cy="460" rx="80" ry="22" fill="url(#errorGrad)" filter="url(#shadow)"/>
  <text x="590" y="457" class="node-text">403</text>
  <text x="590" y="469" class="node-sub">Forbidden</text>

  <!-- Yes branch: bottom -> Read request body -->
  <text x="360" y="510" class="yes-label">Yes</text>
  <line x1="350" y1="495" x2="350" y2="525" class="arrow-yes"/>

  <!-- ============================================================ -->
  <!-- 7. Process: Read request body -->
  <!-- Rect: x=220, y=525, w=260, h=36 -->
  <!-- ============================================================ -->
  <rect x="220" y="525" width="260" height="36" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="350" y="548" class="node-text">Read request body (iCal .ics data)</text>

  <!-- Arrow: Read body -> Parse iCal -->
  <!-- Rect bottom: y=561, next rect top: y=575 -->
  <line x1="350" y1="561" x2="350" y2="575" class="arrow"/>

  <!-- ============================================================ -->
  <!-- 8. Process: Parse iCal data -->
  <!-- Rect: x=195, y=575, w=310, h=48 -->
  <!-- ============================================================ -->
  <rect x="195" y="575" width="310" height="48" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="350" y="595" class="node-text">Parse iCal data</text>
  <text x="350" y="609" class="node-sub">Extract UID, DTSTART, DTEND, SUMMARY (RFC 5545 unfold)</text>

  <!-- Arrow: Parse iCal -> Has If-Match? decision -->
  <!-- Rect bottom: y=623, Diamond top: y=660-35=625 -->
  <!-- Diamond center at y=670, DY=35, top=635 -->
  <line x1="350" y1="623" x2="350" y2="635" class="arrow"/>

  <!-- ============================================================ -->
  <!-- 9. Decision: Has If-Match header? -->
  <!-- Diamond: cx=350, cy=670, DX=100, DY=35 -->
  <!-- Vertices: top=(350,635), right=(450,670), bottom=(350,705), left=(250,670) -->
  <!-- ============================================================ -->
  <polygon points="350,635 450,670 350,705 250,670" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="350" y="667" class="decision-text">Has If-Match</text>
  <text x="350" y="679" class="decision-text">header?</text>

  <!-- No branch: right, then route down to upsert -->
  <!-- No path goes right then down then back to center at the upsert node -->
  <text x="460" y="663" class="no-label">No</text>
  <text x="462" y="675" class="node-sub" style="fill:#999; font: italic 9px sans-serif; text-anchor: start">(or If-Match: *)</text>

  <!-- Yes branch: left -> Look up existing object -->
  <text x="235" y="663" class="yes-label">Yes</text>
  <!-- Single path from diamond left vertex down to rect top -->
  <path d="M250,670 L180,670 L180,700" class="arrow-yes" fill="none"/>

  <!-- ============================================================ -->
  <!-- 10. Process: Look up existing object by UID -->
  <!-- Rect: x=55, y=700, w=250, h=48 -->
  <!-- ============================================================ -->
  <rect x="55" y="700" width="250" height="48" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="180" y="720" class="node-text">Look up existing object</text>
  <text x="180" y="734" class="node-sub">by UID in calendar</text>

  <!-- Arrow: Look up object -> Object exists & ETag matches? -->
  <!-- Rect bottom: y=748, Diamond center at y=800, DY=35, top=765 -->
  <line x1="180" y1="748" x2="180" y2="765" class="arrow"/>

  <!-- ============================================================ -->
  <!-- 11. Decision: Object exists & ETag matches? -->
  <!-- Diamond: cx=180, cy=800, DX=100, DY=35 -->
  <!-- Vertices: top=(180,765), right=(280,800), bottom=(180,835), left=(80,800) -->
  <!-- ============================================================ -->
  <polygon points="180,765 280,800 180,835 80,800" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="180" y="797" class="decision-text">Object exists &amp;</text>
  <text x="180" y="809" class="decision-text">ETag matches?</text>

  <!-- No branch: left -> 412 Precondition Failed (errorGrad) -->
  <!-- Left vertex at (80,800), error ellipse off to the left is tricky on 700px wide canvas -->
  <!-- Let's route it down-left to an error node below-left -->
  <path d="M80,800 L50,800 L50,860 L95,860 L95,873" class="arrow-no" fill="none"/>
  <text x="55" y="793" class="no-label">No</text>

  <ellipse cx="95" cy="895" rx="80" ry="22" fill="url(#errorGrad)" filter="url(#shadow)"/>
  <text x="95" y="892" class="node-text">412</text>
  <text x="95" y="904" class="node-sub">Precondition Failed</text>

  <!-- Yes branch: bottom -> route to upsert (merge with No branch from If-Match) -->
  <text x="190" y="850" class="yes-label">Yes</text>

  <!-- No branch from If-Match decision: right, down, then to upsert rect top -->
  <!-- Upsert rect at x=195, y=915, w=310. Enter at (380,915) from above -->
  <path d="M450,670 L530,670 L530,900 L380,900 L380,915" class="arrow" fill="none"/>

  <!-- Yes path from ETag decision bottom: down then right to upsert rect top -->
  <!-- Enter at (320,915) from above, staggered from the No path -->
  <path d="M180,835 L180,900 L320,900 L320,915" class="arrow-yes" fill="none"/>

  <!-- ============================================================ -->
  <!-- 12. Process: Upsert calendar object -->
  <!-- Rect: x=195, y=915, w=310, h=48 -->
  <!-- ============================================================ -->
  <rect x="195" y="915" width="310" height="48" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="350" y="935" class="node-text">Upsert calendar object</text>
  <text x="350" y="949" class="node-sub">INSERT OR UPDATE with new ETag (UUID)</text>

  <!-- Arrow: Upsert -> Bump ctag -->
  <!-- Rect bottom: y=963, next rect top: y=980 -->
  <line x1="350" y1="963" x2="350" y2="980" class="arrow"/>

  <!-- ============================================================ -->
  <!-- 13. Process: Bump calendar ctag + sync_token -->
  <!-- Rect: x=210, y=980, w=280, h=36 -->
  <!-- ============================================================ -->
  <rect x="210" y="980" width="280" height="36" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="350" y="1003" class="node-text">Bump calendar ctag + sync_token</text>

  <!-- Arrow: Bump ctag -> Log sync_change -->
  <!-- Rect bottom: y=1016, next rect top: y=1033 -->
  <line x1="350" y1="1016" x2="350" y2="1033" class="arrow"/>

  <!-- ============================================================ -->
  <!-- 14. Process: Log sync_change -->
  <!-- Rect: x=210, y=1033, w=280, h=36 -->
  <!-- ============================================================ -->
  <rect x="210" y="1033" width="280" height="36" rx="6" fill="url(#processGrad)" filter="url(#shadow)"/>
  <text x="350" y="1056" class="node-text">Log sync_change (created / modified)</text>

  <!-- Arrow: Log sync -> Create or Update? decision -->
  <!-- Rect bottom: y=1069, Diamond center: y=1115, DY=35, top=1080 -->
  <line x1="350" y1="1069" x2="350" y2="1080" class="arrow"/>

  <!-- ============================================================ -->
  <!-- 15. Decision: Was this a create or update? -->
  <!-- Diamond: cx=350, cy=1115, DX=100, DY=35 -->
  <!-- Vertices: top=(350,1080), right=(450,1115), bottom=(350,1150), left=(250,1115) -->
  <!-- ============================================================ -->
  <polygon points="350,1080 450,1115 350,1150 250,1115" fill="url(#decisionGrad)" filter="url(#shadow)"/>
  <text x="350" y="1112" class="decision-text">Was this a</text>
  <text x="350" y="1124" class="decision-text">create or update?</text>

  <!-- Create branch: left -> 201 Created (endGrad) -->
  <path d="M250,1115 L200,1115 L200,1195" class="arrow-yes" fill="none"/>
  <text x="210" y="1108" class="yes-label">Create</text>

  <ellipse cx="200" cy="1220" rx="90" ry="26" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="200" y="1217" class="node-text">201 Created</text>
  <text x="200" y="1230" class="node-sub">ETag header</text>

  <!-- Update branch: right -> 204 No Content (endGrad) -->
  <path d="M450,1115 L500,1115 L500,1195" class="arrow" fill="none"/>
  <text x="460" y="1108" class="label-text">Update</text>

  <ellipse cx="500" cy="1220" rx="90" ry="26" fill="url(#endGrad)" filter="url(#shadow)"/>
  <text x="500" y="1217" class="node-text">204 No Content</text>
  <text x="500" y="1230" class="node-sub">ETag header</text>

  <!-- ============================================================ -->
  <!-- LEGEND -->
  <!-- ============================================================ -->
  <g transform="translate(30, 1310)">
    <text x="0" y="0" class="label-text" style="font: bold 13px sans-serif">Legend:</text>

    <ellipse cx="90" cy="-4" rx="20" ry="10" fill="url(#startGrad)"/>
    <text x="118" y="0" class="label-text">Start</text>

    <rect x="155" y="-13" width="24" height="17" rx="3" fill="url(#processGrad)"/>
    <text x="185" y="0" class="label-text">Process</text>

    <polygon points="263,-13 276,-4 263,5 250,-4" fill="url(#decisionGrad)"/>
    <text x="283" y="0" class="label-text">Decision</text>

    <ellipse cx="367" cy="-4" rx="20" ry="10" fill="url(#endGrad)"/>
    <text x="393" y="0" class="label-text">Success</text>

    <ellipse cx="457" cy="-4" rx="20" ry="10" fill="url(#errorGrad)"/>
    <text x="483" y="0" class="label-text">Error</text>

    <line x1="530" y1="-4" x2="555" y2="-4" class="arrow-yes"/>
    <text x="562" y="0" class="yes-label">Yes</text>

    <line x1="592" y1="-4" x2="617" y2="-4" class="arrow-no"/>
    <text x="624" y="0" class="no-label">No</text>
  </g>
</svg>
